<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dear Miracle · Board</title>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Tahoma, Verdana, Arial, sans-serif;
      overflow: hidden;
      background: #000;
    }

    :root{
      --titlebar-top: #f7f7f7;
      --titlebar-bot: #e9e9e9;
      --frame: rgba(255,255,255,0.60);
      --glass: rgba(255,255,255,0.40);
      --border: rgba(0,0,0,0.30);
      --shadow: 0 12px 30px rgba(0,0,0,0.22);
      --shadow-strong: 0 18px 46px rgba(0,0,0,0.30);
      --muted: rgba(0,0,0,0.55);
      --danger: rgba(180, 40, 40, 0.95);
      --ok: rgba(0, 120, 80, 0.95);
    }

    .wallpaper {
      position: fixed;
      inset: 0;
      background-image: url("bg.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(0.95) contrast(0.98);
      transform: scale(1.02);
    }
    .wallpaper::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(1200px 600px at 20% 15%, rgba(255,255,255,0.30), transparent 60%),
        radial-gradient(900px 500px at 80% 25%, rgba(255,255,255,0.22), transparent 55%),
        radial-gradient(900px 700px at 55% 80%, rgba(255,255,255,0.18), transparent 60%),
        linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      pointer-events:none;
    }

    .desk { position: fixed; inset: 0; pointer-events: none; }

    .win {
      position: absolute;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      background: var(--frame);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      pointer-events: auto;
      user-select: none;
    }
    .win.is-front { box-shadow: var(--shadow-strong); }

    .titlebar {
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px 0 10px;
      background: linear-gradient(to bottom, var(--titlebar-top), var(--titlebar-bot));
      border-bottom: 1px solid rgba(0,0,0,0.18);
      color: #222;
      cursor: grab;
    }
    .titlebar:active { cursor: grabbing; }

    .title-left { display:flex; align-items:center; gap:8px; min-width:0; }
    .dot {
      width: 10px; height: 10px; border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.75);
      flex: 0 0 auto;
    }
    .title {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .title-btns { display:flex; gap:6px; flex:0 0 auto; align-items:center; }

    .btn, .iconbtn {
      width: 16px; height: 16px; border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.35);
      background: rgba(255,255,255,0.85);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.12);
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 0;
    }
    .iconbtn{
      width: auto;
      height: 22px;
      padding: 0 8px;
      border-radius: 7px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }

    .content {
      background: var(--glass);
      padding: 10px;
      user-select: text;
    }

    /* ===== Board UI ===== */
    .board-top {
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .board-top .desc {
      font-size: 12px;
      color: rgba(0,0,0,0.55);
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.12);
      padding: 6px 8px;
      border-radius: 8px;
      flex: 1;
      line-height: 1.35;
    }
    .board-top .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .pill {
      height: 32px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.88);
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
    }
    .pill:active{ transform: translateY(1px); }
    .pill.danger{
      border-color: rgba(180,40,40,0.35);
      background: rgba(255,255,255,0.88);
      color: #7b0e0e;
    }

    .subline{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .whoami{
      font-size: 12px;
      color: rgba(0,0,0,0.65);
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.12);
      padding: 6px 10px;
      border-radius: 10px;
    }

    .list {
      display: grid;
      gap: 10px;
      max-height: 520px;
      overflow: auto;
      padding-right: 4px;
    }

    .card {
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 12px;
      padding: 12px;
    }
    .card h3 { margin: 0 0 8px; font-size: 15px; }
    .meta {
      display:flex; gap:10px; flex-wrap:wrap;
      font-size: 11px; color: rgba(0,0,0,0.58);
      margin-bottom: 10px;
    }
    .text { font-size: 13px; line-height: 1.45; white-space: pre-wrap; color:#222; }

    .card-actions{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .mini {
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.90);
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
    }
    .mini.ghost{
      background: rgba(255,255,255,0.65);
      font-weight: 700;
    }
    .mini.danger{
      border-color: rgba(180,40,40,0.35);
      color: #7b0e0e;
    }

    .status{
      margin-top:10px;
      font-size: 11px;
      color: rgba(0,0,0,0.60);
    }

    /* ===== Modal Backdrop ===== */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:center; justify-content:center;
      padding: 14px;
      z-index: 9999;
      pointer-events: auto;
    }
    .modal{
      width: min(760px, 100%);
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 12px;
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .modal .content{ background: transparent; }

    .field{ display:grid; gap:6px; margin-bottom: 10px; }
    .label{ font-size: 12px; color: rgba(0,0,0,0.65); font-weight: 800; }
    .field input, .field textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.90);
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
    }
    .field textarea{ min-height: 170px; resize: vertical; line-height: 1.45; }
    .field input[readonly]{
      background: rgba(255,255,255,0.70);
      color: rgba(0,0,0,0.65);
    }
    .modal-actions{
      display:flex; justify-content:flex-end; gap:8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .hint{
      margin-top:8px;
      font-size: 11px;
      color: rgba(0,0,0,0.60);
      line-height: 1.35;
    }

    /* ===== Inbox list ===== */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .tab{
      height: 32px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.75);
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
    }
    .tab.active{
      background: rgba(255,255,255,0.92);
    }
    .msg{
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .msg .top{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size: 11px;
      color: rgba(0,0,0,0.60);
      margin-bottom: 8px;
    }
    .msg .body{
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      color:#222;
    }

    /* taskbar */
    .taskbar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 44px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,0.18);
      pointer-events: auto;
    }
    .brand { font-size: 13px; color:#222; font-weight:900; letter-spacing:0.2px; }
    .spacer { flex:1; }
    .clock { font-size: 12px; color: rgba(0,0,0,0.65); font-variant-numeric: tabular-nums; }

    /* ===== Responsive ===== */
    @media (max-width: 980px){
      #boardWin{ width: calc(100vw - 24px) !important; left: 12px !important; }
      .list{ max-height: calc(100vh - 220px); }
    }
    @media (max-width: 560px){
      .titlebar{ height: 36px; }
      .title{ font-size: 13px; max-width: 260px; }
      .pill{ height: 38px; font-size: 13px; }
      .mini{ height: 36px; font-size: 13px; }
      .whoami{ font-size: 13px; }
      .card h3{ font-size: 16px; }
      .text{ font-size: 14px; }
      .field input, .field textarea{ font-size: 15px; }
      .modal{ width: 100%; }
      .list{ max-height: calc(100vh - 240px); }
    }
  </style>
</head>

<body>
  <div class="wallpaper"></div>

  <div class="desk" id="desk">
    <!-- ✅ 게시판 윈도우 -->
    <div class="win is-front" id="boardWin" style="left:60px; top:50px; width: 920px;" data-z="50">
      <div class="titlebar">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">구인 게시판</div>
        </div>
        <div class="title-btns">
          <button class="iconbtn" id="btnNick" title="닉네임 변경">닉</button>
          <button class="iconbtn" id="btnAdmin" title="관리자">관리</button>
          <button class="iconbtn" id="btnInbox" title="쪽지함">쪽지</button>
          <button class="iconbtn" id="btnWrite" title="글쓰기">글</button>
          <button class="iconbtn" id="btnHome" title="홈으로">홈</button>
          <button class="iconbtn" id="btnReload" title="새로고침">↻</button>
        </div>
      </div>

      <div class="content">
        <div class="board-top">
          <div class="desc">
            전체 공개 · 컨택은 <b>쪽지</b>로 진행합니다. (비밀댓글 대신 DM)
          </div>
          <div class="actions">
            <button class="pill" id="homeBtn">← 홈으로</button>
            <button class="pill" id="inboxBtn">내 쪽지함</button>
            <button class="pill" id="writeBtn">글쓰기</button>
          </div>
        </div>

        <div class="subline">
          <div class="whoami" id="whoami">닉네임: (불러오는 중...)</div>
          <button class="pill" id="changeNickBtn">닉네임 바꾸기</button>
        </div>

        <div class="list" id="list"></div>
        <div class="status" id="status"></div>
      </div>
    </div>
  </div>

  <!-- ✅ 닉네임 로그인 모달 -->
  <div class="modal-backdrop" id="nickBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">닉네임 입력</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closeNick" title="닫기"></button>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <div class="label">닉네임</div>
          <input id="nickInput" placeholder="예: DearMiracle / ㅇㅇ / 닉네임" maxlength="30" />
        </div>
        <div class="modal-actions">
          <button class="pill" id="nickCancel">취소</button>
          <button class="pill" id="nickSave">확인</button>
        </div>
        <div class="hint">
          비밀번호 없이 <b>닉네임만</b> 사용합니다.<br/>
          (가개장용 · 간편 모드)
        </div>
        <div class="hint" id="nickHint"></div>
      </div>
    </div>
  </div>
  
<!-- ✅ 관리자 모달 -->
<div class="modal-backdrop" id="adminBg">
  <div class="modal">
    <div class="titlebar" style="cursor: default;">
      <div class="title-left">
        <div class="dot"></div>
        <div class="title">관리자 코드</div>
      </div>
      <div class="title-btns">
        <button class="btn" id="closeAdmin" title="닫기"></button>
      </div>
    </div>

    <div class="content">
      <div class="field">
        <div class="label">코드</div>
        <input id="adminInput" placeholder="관리자 코드 입력" />
      </div>
      <div class="modal-actions">
        <button class="pill" id="adminOff">관리 해제</button>
        <button class="pill" id="adminOn">확인</button>
      </div>
      <div class="hint" id="adminHint"></div>
    </div>
  </div>
</div>

  <!-- ✅ 글쓰기/수정 모달 -->
  <div class="modal-backdrop" id="postBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title" id="postModalTitle">새 글</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closePost" title="닫기"></button>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <div class="label">제목</div>
          <input id="inpTitle" placeholder="예: 관계 구합니다 / 선관계 구인 / 00페어" maxlength="80" />
        </div>

        <div class="field">
          <div class="label">작성자(자동)</div>
          <input id="inpAuthor" readonly />
        </div>

        <div class="field">
          <div class="label">내용</div>
          <textarea id="inpContent" placeholder="구인 내용 / 조건 / 기간 / 연락 방식 등을 적어주세요."></textarea>
        </div>

        <div class="modal-actions">
          <button class="pill" id="postCancel">취소</button>
          <button class="pill" id="postSubmit">등록</button>
        </div>
        <div class="hint" id="postHint"></div>
      </div>
    </div>
  </div>

  <!-- ✅ 쪽지 보내기 모달 -->
  <div class="modal-backdrop" id="dmBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">쪽지 보내기</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closeDM" title="닫기"></button>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <div class="label">받는 사람</div>
          <input id="dmTo" readonly />
        </div>
        <div class="field">
          <div class="label">보내는 사람</div>
          <input id="dmFrom" readonly />
        </div>
        <div class="field">
          <div class="label">내용</div>
          <textarea id="dmBody" placeholder="컨택 내용을 적어주세요."></textarea>
        </div>

        <div class="modal-actions">
          <button class="pill" id="dmCancel">취소</button>
          <button class="pill" id="dmSend">보내기</button>
        </div>
        <div class="hint" id="dmHint"></div>
      </div>
    </div>
  </div>

  <!-- ✅ 쪽지함 모달 -->
  <div class="modal-backdrop" id="inboxBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">내 쪽지함</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closeInbox" title="닫기"></button>
        </div>
      </div>

      <div class="content">
        <div class="tabs">
          <button class="tab active" id="tabRecv">받은 쪽지</button>
          <button class="tab" id="tabSent">보낸 쪽지</button>
          <button class="pill" id="inboxRefresh">새로고침</button>
        </div>

        <div id="inboxList" style="max-height: 520px; overflow:auto; padding-right:4px;"></div>
        <div class="hint" id="inboxHint"></div>
      </div>
    </div>
  </div>

  <div class="taskbar">
    <div class="brand">DEAR MIRACLE</div>
    <div class="spacer"></div>
    <div class="clock" id="clock">--:--</div>
  </div>

  <!-- =========================
       ✅ Firebase + Board Script
       ========================= -->
  <script type="module">
    // =========================
    // 0) Firebase import (CDN)
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, limit,
      serverTimestamp, doc, updateDoc, deleteDoc, where
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // =========================
    // ✅ 1) 여기에 firebaseConfig 붙여넣기
    // =========================
   const firebaseConfig = {
  apiKey: "AIzaSyA1PxEOrwjVi4BOLA13UbFIncTYe6RdYIQ",
  authDomain: "dear-miracle.firebaseapp.com",
  projectId: "dear-miracle",
  storageBucket: "dear-miracle.firebasestorage.app",
  messagingSenderId: "793139917614",
  appId: "1:793139917614:web:dec74f65af6a0df1c740bf",
  measurementId: "G-VF22L8ZR6D"
};

    // ⚠️ 여기 빈 채로 두면 동작 안 함
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =========================
    // 1) 공용 유틸
    // =========================
    const $ = (id)=>document.getElementById(id);

    function fmtTime(ts){
      if(!ts) return "";
      // Firestore Timestamp 형태면 toDate() 가능
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const yy = String(d.getFullYear()).slice(2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${yy}.${mm}.${dd} ${hh}:${mi}`;
      }catch{
        return "";
      }
    }

    function setStatus(msg){
      $("status").textContent = msg || "";
    }

    // =========================
    // 2) 닉네임(비번 없는 세션)
    // =========================
    const NICK_KEY = "dm_nick";
    function getNick(){ return (localStorage.getItem(NICK_KEY) || "").trim(); }
    function setNick(n){ localStorage.setItem(NICK_KEY, n.trim()); }

    function updateWhoAmI(){
      const n = getNick();
      $("whoami").textContent = n ? `닉네임: ${n}` : "닉네임: (없음)";
      $("inpAuthor").value = n || "";
      $("dmFrom").value = n || "";
    }

    // 닉 모달 열기/닫기
    const nickBg = $("nickBg");
    function openNickModal(force=false){
      $("nickHint").textContent = "";
      $("nickInput").value = getNick();
      nickBg.style.display = "flex";
      if(force) $("closeNick").style.display = "none";
      else $("closeNick").style.display = "inline-flex";
      setTimeout(()=> $("nickInput").focus(), 50);
    }
    function closeNickModal(){
      nickBg.style.display = "none";
    }

    function ensureNick(){
      const n = getNick();
      if(!n){
        openNickModal(true);
        return false;
      }
      return true;
    }

    // 닉 저장
    $("nickSave").onclick = async ()=>{
      const val = $("nickInput").value.trim();
      if(!val){
        $("nickHint").textContent = "닉네임을 입력해주세요.";
        return;
      }
      setNick(val);
      updateWhoAmI();
      closeNickModal();
      await loadPosts();
    };
    $("nickCancel").onclick = ()=>{
      if(getNick()) closeNickModal();
      else $("nickHint").textContent = "닉네임을 입력해야 진행할 수 있습니다.";
    };
    $("closeNick").onclick = closeNickModal;
    nickBg.addEventListener("click", (e)=>{ if(e.target===nickBg && getNick()) closeNickModal(); });

    // =========================
    // 3) 네비 버튼
    // =========================
    const goHome = ()=> location.href = "index.html";
    $("homeBtn").onclick = goHome;
    $("btnHome").onclick = goHome;
    $("btnReload").onclick = ()=> location.reload();

    $("btnNick").onclick = ()=> openNickModal(false);
    $("changeNickBtn").onclick = ()=> openNickModal(false);

    // =========================
    // 4) 글쓰기/수정 모달
    // =========================
    const postBg = $("postBg");
    let editingPostId = null;

    function openPostModal(mode="new", post=null){
      if(!ensureNick()) return;

      $("postHint").textContent = "";
      if(mode==="edit" && post){
        editingPostId = post.id;
        $("postModalTitle").textContent = "글 수정";
        $("postSubmit").textContent = "수정";
        $("inpTitle").value = post.title || "";
        $("inpContent").value = post.content || "";
      }else{
        editingPostId = null;
        $("postModalTitle").textContent = "새 글";
        $("postSubmit").textContent = "등록";
        $("inpTitle").value = "";
        $("inpContent").value = "";
      }
      $("inpAuthor").value = getNick();
      postBg.style.display = "flex";
      setTimeout(()=> $("inpTitle").focus(), 50);
    }
    function closePostModal(){ postBg.style.display = "none"; }

    $("writeBtn").onclick = ()=> openPostModal("new");
    $("btnWrite").onclick = ()=> openPostModal("new");
    $("postCancel").onclick = closePostModal;
    $("closePost").onclick = closePostModal;
    postBg.addEventListener("click", (e)=>{ if(e.target===postBg) closePostModal(); });

    // 등록/수정 저장
    $("postSubmit").onclick = async ()=>{
      if(!ensureNick()) return;

      const title = $("inpTitle").value.trim();
      const content = $("inpContent").value.trim();
      const author = getNick();

      if(!title){
        $("postHint").textContent = "제목을 입력해주세요.";
        return;
      }
      if(!content){
        $("postHint").textContent = "내용을 입력해주세요.";
        return;
      }

      try{
        $("postSubmit").disabled = true;
        $("postHint").textContent = "저장 중…";

        if(editingPostId){
          const ref = doc(db, "posts", editingPostId);
          await updateDoc(ref, {
            title, content,
            updatedAt: serverTimestamp()
          });
          $("postHint").textContent = "수정되었습니다.";
        }else{
          await addDoc(collection(db, "posts"), {
            title, content, author,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          $("postHint").textContent = "등록되었습니다.";
        }

        closePostModal();
        await loadPosts();
      }catch(err){
        console.error(err);
        $("postHint").textContent = "저장에 실패했습니다.";
      }finally{
        $("postSubmit").disabled = false;
      }
    };

    // =========================
    // 5) 쪽지 보내기 모달
    // =========================
    const dmBg = $("dmBg");
    let dmTargetNick = "";
    let dmTargetPostId = "";

    function openDMModal(toNick, postId=""){
      if(!ensureNick()) return;
      dmTargetNick = toNick || "";
      dmTargetPostId = postId || "";
      $("dmHint").textContent = "";
      $("dmTo").value = dmTargetNick;
      $("dmFrom").value = getNick();
      $("dmBody").value = "";
      dmBg.style.display = "flex";
      setTimeout(()=> $("dmBody").focus(), 50);
    }
    function closeDMModal(){ dmBg.style.display = "none"; }

    $("closeDM").onclick = closeDMModal;
    $("dmCancel").onclick = closeDMModal;
    dmBg.addEventListener("click", (e)=>{ if(e.target===dmBg) closeDMModal(); });

    $("dmSend").onclick = async ()=>{
      if(!ensureNick()) return;
      const from = getNick();
      const to = (dmTargetNick || "").trim();
      const body = $("dmBody").value.trim();

      if(!to){
        $("dmHint").textContent = "받는 사람이 없습니다.";
        return;
      }
      if(to === from){
        $("dmHint").textContent = "자기 자신에게는 보낼 수 없습니다.";
        return;
      }
      if(!body){
        $("dmHint").textContent = "내용을 입력해주세요.";
        return;
      }

      try{
        $("dmSend").disabled = true;
        $("dmHint").textContent = "전송 중…";

        await addDoc(collection(db, "messages"), {
          from, to, body,
          postId: dmTargetPostId || "",
          createdAt: serverTimestamp()
        });

        $("dmHint").textContent = "전송되었습니다.";
        closeDMModal();
      }catch(err){
        console.error(err);
        $("dmHint").textContent = "전송에 실패했습니다.";
      }finally{
        $("dmSend").disabled = false;
      }
    };

    // =========================
    // 6) 쪽지함 모달
    // =========================
    const inboxBg = $("inboxBg");
    let inboxMode = "recv"; // recv | sent

    function openInbox(){
      if(!ensureNick()) return;
      inboxBg.style.display = "flex";
      setInboxTab("recv");
      loadInbox();
    }
    function closeInbox(){ inboxBg.style.display = "none"; }

    function setInboxTab(mode){
      inboxMode = mode;
      $("tabRecv").classList.toggle("active", mode==="recv");
      $("tabSent").classList.toggle("active", mode==="sent");
    }

    $("inboxBtn").onclick = openInbox;
    $("btnInbox").onclick = openInbox;
    $("closeInbox").onclick = closeInbox;
    inboxBg.addEventListener("click", (e)=>{ if(e.target===inboxBg) closeInbox(); });

    $("tabRecv").onclick = ()=>{ setInboxTab("recv"); loadInbox(); };
    $("tabSent").onclick = ()=>{ setInboxTab("sent"); loadInbox(); };
    $("inboxRefresh").onclick = ()=> loadInbox();

    async function loadInbox(){
      if(!ensureNick()) return;
      const me = getNick();
      $("inboxHint").textContent = "불러오는 중…";
      $("inboxList").innerHTML = "";

      try{
        let qy;
        if(inboxMode === "recv"){
          qy = query(
            collection(db, "messages"),
            where("to", "==", me),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        }else{
          qy = query(
            collection(db, "messages"),
            where("from", "==", me),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        }

        const snap = await getDocs(qy);
        if(snap.empty){
          $("inboxHint").textContent = inboxMode==="recv" ? "받은 쪽지가 없습니다." : "보낸 쪽지가 없습니다.";
          return;
        }

        const frag = document.createDocumentFragment();
        snap.forEach(docu=>{
          const m = docu.data();
          const div = document.createElement("div");
          div.className = "msg";
          const top = document.createElement("div");
          top.className = "top";
          const who = inboxMode==="recv"
            ? `보낸 사람: ${m.from || "-"}`
            : `받는 사람: ${m.to || "-"}`;
          const t = fmtTime(m.createdAt);
          const ref = m.postId ? `연결글: ${m.postId}` : "";
          top.textContent = `${who} · ${t}${ref ? " · " + ref : ""}`;

          const body = document.createElement("div");
          body.className = "body";
          body.textContent = m.body || "";

          div.appendChild(top);
          div.appendChild(body);
          frag.appendChild(div);
        });

        $("inboxList").appendChild(frag);
        $("inboxHint").textContent = "";
      }catch(err){
        console.error(err);
        $("inboxHint").textContent = "쪽지함을 불러오지 못했습니다.";
      }
    }

    // =========================
    // 7) 게시글 목록 로드/렌더
    // =========================
    async function loadPosts(){
      setStatus("불러오는 중…");
      $("list").innerHTML = "";

      try{
        // 최신순 50개
        const qy = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(50));
        const snap = await getDocs(qy);

        if(snap.empty){
          setStatus("아직 글이 없습니다. 첫 글을 작성해보세요.");
          return;
        }

        const me = getNick();
        const frag = document.createDocumentFragment();

        snap.forEach(docu=>{
          const p = docu.data();
          const id = docu.id;

          const card = document.createElement("div");
          card.className = "card";

          const h = document.createElement("h3");
          h.textContent = p.title || "(제목 없음)";

          const meta = document.createElement("div");
          meta.className = "meta";
          const author = p.author || "-";
          const created = fmtTime(p.createdAt);
          const updated = fmtTime(p.updatedAt);
          meta.textContent = `작성자: ${author} · 작성: ${created}${updated ? " · 수정: " + updated : ""}`;

          const text = document.createElement("div");
          text.className = "text";
          text.textContent = p.content || "";

          const actions = document.createElement("div");
          actions.className = "card-actions";

          // 쪽지 보내기
          const btnDM = document.createElement("button");
          btnDM.className = "mini";
          btnDM.textContent = "쪽지 보내기";
          btnDM.onclick = ()=> openDMModal(author, id);

          // 내 글이면 수정/삭제 버튼 노출
          actions.appendChild(btnDM);

          if(me && author === me){
            const btnEdit = document.createElement("button");
            btnEdit.className = "mini ghost";
            btnEdit.textContent = "수정";
            btnEdit.onclick = ()=> openPostModal("edit", { id, title: p.title, content: p.content });

            const btnDel = document.createElement("button");
            btnDel.className = "mini danger";
            btnDel.textContent = "삭제";
            btnDel.onclick = async ()=>{
              const ok = confirm("정말 삭제하시겠습니까?");
              if(!ok) return;
              try{
                await deleteDoc(doc(db, "posts", id));
                await loadPosts();
              }catch(err){
                console.error(err);
                alert("삭제에 실패했습니다.");
              }
            };

            actions.appendChild(btnEdit);
            actions.appendChild(btnDel);
          }

          card.appendChild(h);
          card.appendChild(meta);
          card.appendChild(text);
          card.appendChild(actions);

          frag.appendChild(card);
        });

        $("list").appendChild(frag);
        setStatus("");
      }catch(err){
        console.error(err);
        setStatus("게시글을 불러오지 못했습니다.");
      }
    }

    // =========================
    // 8) 창 드래그 + 앞으로 가져오기
    // =========================
    const wins = Array.from(document.querySelectorAll(".win"));
    let topZ = 100;

    function bringToFront(win){
      topZ += 1;
      win.style.zIndex = topZ;
      wins.forEach(w => w.classList.remove("is-front"));
      win.classList.add("is-front");
    }

    wins.forEach(win => {
      const initZ = parseInt(win.getAttribute("data-z") || "0", 10);
      win.style.zIndex = 50 + initZ;

      win.addEventListener("pointerdown", () => bringToFront(win));

      const bar = win.querySelector(".titlebar");
      if(!bar) return;

      let dragging = false;
      let startX = 0, startY = 0, winX = 0, winY = 0;

      bar.addEventListener("pointerdown", (e) => {
        // 버튼 클릭은 드래그로 안 잡히게
        const t = e.target;
        if(t && (t.tagName === "BUTTON" || t.classList.contains("btn") || t.classList.contains("iconbtn"))) return;

        bringToFront(win);
        dragging = true;
        bar.setPointerCapture(e.pointerId);

        const rect = win.getBoundingClientRect();
        startX = e.clientX; startY = e.clientY;
        winX = rect.left;  winY = rect.top;
        e.preventDefault();
      });

      bar.addEventListener("pointermove", (e) => {
        if(!dragging) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let nx = winX + dx;
        let ny = winY + dy;

        const maxX = window.innerWidth - 60;
        const maxY = window.innerHeight - 120; // taskbar 고려
        nx = Math.min(Math.max(nx, -40), maxX);
        ny = Math.min(Math.max(ny, -20), maxY);

        win.style.left = nx + "px";
        win.style.top  = ny + "px";
      });

      bar.addEventListener("pointerup", () => dragging = false);
      bar.addEventListener("pointercancel", () => dragging = false);
    });

    // =========================
    // 9) 시계
    // =========================
    const clock = $("clock");
    function tick(){
      const d = new Date();
      clock.textContent = String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0");
    }
    tick(); setInterval(tick, 10000);

    // =========================
    // 10) 초기 실행
    // =========================
    updateWhoAmI();

    // 닉 없으면 강제 모달
    if(!getNick()){
      openNickModal(true);
    }else{
      await loadPosts();
    }
  </script>
</body>
</html>
