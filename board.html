<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dear Miracle Â· Board</title>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Tahoma, Verdana, Arial, sans-serif;
      overflow: hidden;
      background: #000;
    }

    :root{
      --titlebar-top: #f7f7f7;
      --titlebar-bot: #e9e9e9;
      --frame: rgba(255,255,255,0.60);
      --glass: rgba(255,255,255,0.40);
      --border: rgba(0,0,0,0.30);
      --shadow: 0 12px 30px rgba(0,0,0,0.22);
      --shadow-strong: 0 18px 46px rgba(0,0,0,0.30);
      --muted: rgba(0,0,0,0.55);
      --danger: rgba(180, 40, 40, 0.95);
      --ok: rgba(0, 120, 80, 0.95);
    }

    .wallpaper {
      position: fixed;
      inset: 0;
      background-image: url("bg.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(0.95) contrast(0.98);
      transform: scale(1.02);
    }
    .wallpaper::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(1200px 600px at 20% 15%, rgba(255,255,255,0.30), transparent 60%),
        radial-gradient(900px 500px at 80% 25%, rgba(255,255,255,0.22), transparent 55%),
        radial-gradient(900px 700px at 55% 80%, rgba(255,255,255,0.18), transparent 60%),
        linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      pointer-events:none;
    }

    .desk { position: fixed; inset: 0; pointer-events: none; }

    .win {
      position: absolute;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      background: var(--frame);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      pointer-events: auto;
      user-select: none;
    }
    .win.is-front { box-shadow: var(--shadow-strong); }

    .titlebar {
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px 0 10px;
      background: linear-gradient(to bottom, var(--titlebar-top), var(--titlebar-bot));
      border-bottom: 1px solid rgba(0,0,0,0.18);
      color: #222;
      cursor: grab;
    }
    .titlebar:active { cursor: grabbing; }

    .title-left { display:flex; align-items:center; gap:8px; min-width:0; }
    .dot {
      width: 10px; height: 10px; border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.75);
      flex: 0 0 auto;
    }
    .title {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .title-btns { display:flex; gap:6px; flex:0 0 auto; align-items:center; }

    .btn, .iconbtn {
      width: 16px; height: 16px; border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.35);
      background: rgba(255,255,255,0.85);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.12);
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 0;
    }
    .iconbtn{
      width: auto;
      height: 26px;
      padding: 0 8px;
      border-radius: 7px;
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      position: relative; /* âœ… ë±ƒì§€ ì–¹ê¸° */
    }

    /* âœ… ìª½ì§€ ë±ƒì§€(ë³´ë“œìš©) */
    .inbox-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.92);
      font-weight: 900;
      font-size: 11px;
      display:none;
      align-items:center;
      justify-content:center;
      line-height: 1;
    }

    .content {
      background: var(--glass);
      padding: 10px;
      user-select: text;
    }

    /* ===== Board UI ===== */
    .board-top {
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .board-top .desc {
      font-size: 13px;
      color: rgba(0,0,0,0.55);
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.12);
      padding: 6px 8px;
      border-radius: 8px;
      flex: 1;
      line-height: 1.35;
    }
    .board-top .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .pill {
      height: 32px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.88);
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
    }
    .pill:active{ transform: translateY(1px); }
    .pill.danger{
      border-color: rgba(180,40,40,0.35);
      background: rgba(255,255,255,0.88);
      color: #7b0e0e;
    }

    .subline{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .whoami{
      font-size: 12px;
      color: rgba(0,0,0,0.65);
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.12);
      padding: 6px 10px;
      border-radius: 10px;
    }

    .list {
      display: grid;
      gap: 10px;
      max-height: 520px;
      overflow: auto;
      padding-right: 4px;
    }

    .card {
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 12px;
      padding: 12px;
    }
    .card h3 { margin: 0 0 8px; font-size: 17px; }
    .meta {
      display:flex; gap:10px; flex-wrap:wrap;
      font-size: 12px; color: rgba(0,0,0,0.58);
      margin-bottom: 10px;
    }
    .text { font-size: 14px; line-height: 1.55; white-space: pre-wrap; color:#222; }

    .card-actions{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .mini {
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.90);
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
    }
    .mini.ghost{
      background: rgba(255,255,255,0.65);
      font-weight: 700;
    }
    .mini.danger{
      border-color: rgba(180,40,40,0.35);
      color: #7b0e0e;
    }

    .status{
      margin-top:10px;
      font-size: 11px;
      color: rgba(0,0,0,0.60);
    }

    /* ===== Modal Backdrop ===== */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:center; justify-content:center;
      padding: 14px;
      z-index: 9999;
      pointer-events: auto;
    }
    .modal{
      width: min(760px, 100%);
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 12px;
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .modal .content{ background: transparent; }

    .field{ display:grid; gap:6px; margin-bottom: 10px; }
    .label{ font-size: 12px; color: rgba(0,0,0,0.65); font-weight: 800; }
    .field input, .field textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.90);
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
    }
    .field textarea{ min-height: 170px; resize: vertical; line-height: 1.45; }
    .field input[readonly]{
      background: rgba(255,255,255,0.70);
      color: rgba(0,0,0,0.65);
    }
    .modal-actions{
      display:flex; justify-content:flex-end; gap:8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .hint{
      margin-top:8px;
      font-size: 11px;
      color: rgba(0,0,0,0.60);
      line-height: 1.35;
    }

    /* ===== Inbox list ===== */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .tab{
      height: 32px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.75);
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
    }
    .tab.active{
      background: rgba(255,255,255,0.92);
    }
    .msg{
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .msg .top{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size: 11px;
      color: rgba(0,0,0,0.60);
      margin-bottom: 8px;
    }
    .msg .body{
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      color:#222;
    }
    .msg .actions{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* =========================
       âœ… Responsive (ê°€ë…ì„±/ë²„íŠ¼í¬ê¸°)
       ========================= */
    @media (max-width: 560px){
      #boardWin{
        left: 10px !important;
        top: 10px !important;
        width: calc(100vw - 20px) !important;
        height: calc(100vh - 20px) !important; 
      }
      .list{ max-height: calc(100vh - 240px); }
    }

    @media (max-width: 560px){
      .titlebar{ height: 36px; }
      .title{ font-size: 14px; max-width: 260px; }

      .pill{ height: 44px; font-size: 14px; }
      .mini{ height: 42px; font-size: 14px; }

      .whoami{ font-size: 13px; }
      .card h3{ font-size: 16px; }
      .text{ font-size: 15px; line-height: 1.6; }

      .field input, .field textarea{ font-size: 15px; }
      .modal{ width: 100%; }
      .list{ max-height: calc(100vh - 260px); }
    }

    /* =========================
       âœ… ì¹´í†¡í˜• ë©”ì‹ ì €: ëª¨ë°”ì¼ í’€í™”ë©´
       ========================= */
    @media (max-width: 768px){
      #dmWin{
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        top: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        border-radius: 0 !important;
      }
      #dmFabBtn{
        right: 14px !important;
        bottom: calc(18px + env(safe-area-inset-bottom)) !important;
        width: 64px !important;
        height: 64px !important;
        border-radius: 22px !important;
        font-size: 26px !important;
      }
    }

    /* ëª¨ë‹¬ì´ ë„ˆë¬´ ì»¤ì§€ë©´ ìŠ¤í¬ë¡¤ */
    @media (max-width: 560px){
      .modal{
        width: calc(100vw - 20px) !important;
        max-height: calc(100vh - 40px) !important;
      }
      .modal .content{
        max-height: calc(100vh - 120px) !important;
        overflow: auto !important;
      }
    }
  </style>

<!-- >>> Added by ChatGPT: font split for UI vs content >>> -->
<style>
@font-face{
  font-family:'RoundedFixedsys';
  src:url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
  font-weight:400;
  font-style:normal;
  font-display:swap;
}
:root{
  --ui-font:'RoundedFixedsys', 'DungGeunMo', system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
  --text-font:'Noto Sans KR', 'Noto Sans', Apple SD Gothic Neo, system-ui, sans-serif;
}
/* Window chrome / top controls use pixel UI font */
.titlebar, .titlebar *,
.title, .title *,
.tabs, .tabs *,
.title-btns, .title-btns *,
.iconbtn, .btn, .pill,
.board-top, .board-top *,
.subline, .subline *,
.hint, .hint * {
  font-family: var(--ui-font) !important;
  letter-spacing: .1px;
}
/* Main article/content area keeps Noto Sans for readability */
.content, .content *,
.list, .list *,
.desc, .desc *,
.field, .field *,
.label, .label * {
  font-family: var(--text-font) !important;
}
</style>
<!-- <<< Added by ChatGPT -->

</head>

<body>
  <div class="wallpaper"></div>

  <div class="desk" id="desk">
    <!-- âœ… ê²Œì‹œíŒ ìœˆë„ìš° -->
    <div class="win is-front" id="boardWin" style="left:60px; top:50px; width: 1100px;" data-z="50">
      <div class="titlebar">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">êµ¬ì¸ ê²Œì‹œíŒ</div>
        </div>
        <div class="title-btns">
          <button class="iconbtn" id="btnNick" title="ë‹‰ë„¤ì„ ë³€ê²½">ë‹‰</button>
          <button class="iconbtn" id="btnAdmin" title="ê´€ë¦¬ì">ê´€ë¦¬</button>

          <!-- âœ… ìª½ì§€ ë²„íŠ¼ + ì•ˆì½ìŒ ë±ƒì§€(ë³´ë“œ ê¸°ë³¸) -->
          <button class="iconbtn" id="btnInbox" title="ìª½ì§€í•¨">
            ìª½ì§€
            <span class="inbox-badge" id="inboxBadge">0</span>
          </button>

          <button class="iconbtn" id="btnWrite" title="ê¸€ì“°ê¸°">ê¸€</button>
          <button class="iconbtn" id="btnHome" title="í™ˆìœ¼ë¡œ">í™ˆ</button>
          <button class="iconbtn" id="btnReload" title="ìƒˆë¡œê³ ì¹¨">â†»</button>
        </div>
      </div>

      <div class="content">
        <div class="board-top">
          <div class="desc">
            ì „ì²´ ê³µê°œ Â· ì»¨íƒì€ <b>ìª½ì§€</b>ë¡œ ì§„í–‰í•©ë‹ˆë‹¤. (ë¹„ë°€ëŒ“ê¸€ ëŒ€ì‹  DM)
          </div>
          <div class="actions">
            <button class="pill" id="homeBtn">â† í™ˆìœ¼ë¡œ</button>
            <button class="pill" id="inboxBtn">ë‚´ ìª½ì§€í•¨</button>
            <button class="pill" id="writeBtn">ê¸€ì“°ê¸°</button>
          </div>
        </div>

        <div class="subline">
          <div class="whoami" id="whoami">ë‹‰ë„¤ì„: (ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...)</div>
          <button class="pill" id="changeNickBtn">ë‹‰ë„¤ì„ ë°”ê¾¸ê¸°</button>
        </div>

        <div class="list" id="list"></div>
        <div class="status" id="status"></div>
      </div>
    </div>
  </div>

  <!-- =========================
       âœ… ì¹´í†¡í˜• ë©”ì‹ ì € (ë³´ë“œ ì „ìš© 1ì„¸íŠ¸)
       â€» ë³´ë“œ ê¸°ë³¸ dmTo/dmBody/dmSendì™€ ì¶©ëŒ ë°©ì§€: dm2* ì‚¬ìš©
       ========================= -->

  <!-- ìš°í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼ -->
  <button id="dmFabBtn" title="ë©”ì‹ ì €" aria-label="ë©”ì‹ ì €"
    style="
      position:fixed;
      right:18px;
      bottom:calc(18px + env(safe-area-inset-bottom));
      width:64px; height:64px;
      border-radius:22px;
      border:1px solid rgba(0,0,0,0.22);
      background:rgba(255,255,255,0.92);
      box-shadow:0 12px 30px rgba(0,0,0,0.28);
      display:flex; align-items:center; justify-content:center;
      font-size:26px;
      cursor:pointer;
      z-index:99998;">
    ğŸ’¬
  </button>

  <!-- ë©”ì‹ ì € ì°½ -->
  <div id="dmWin"
    style="
      position:fixed;
      right:14px;
      bottom:calc(96px + env(safe-area-inset-bottom));
      width:min(380px, calc(100vw - 28px));
      height:min(600px, calc(100vh - 220px));
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.22);
      background:rgba(255,255,255,0.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 46px rgba(0,0,0,0.35);
      z-index:99999;
      display:none;">

    <!-- ìƒë‹¨ë°” -->
    <div id="dmTop"
      style="
        height:40px;
        display:flex; align-items:center; justify-content:space-between;
        padding:0 10px;
        background: linear-gradient(to bottom, rgba(247,247,247,0.96), rgba(233,233,233,0.96));
        border-bottom:1px solid rgba(0,0,0,0.16);
        cursor:grab;">
      <div style="display:flex; align-items:center; gap:8px; min-width:0;">
        <div style="width:10px; height:10px; border-radius:2px; border:1px solid rgba(0,0,0,0.22); background:rgba(255,255,255,0.85);"></div>
        <div style="font-size:13px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ë©”ì‹ ì €
        </div>

        <!-- ì•ˆì½ìŒ ë±ƒì§€ -->
        <span id="dmBadge"
          style="
            margin-left:6px;
            min-width:18px; height:18px; padding:0 6px;
            border-radius:999px;
            border:1px solid rgba(0,0,0,0.22);
            background:rgba(255,255,255,0.95);
            font-size:11px; font-weight:900;
            display:none;
            align-items:center; justify-content:center;">
          0
        </span>
      </div>

      <div style="display:flex; align-items:center; gap:8px;">
        <button id="dmTabBtn"
          style="
            height:28px; padding:0 10px;
            border-radius:10px;
            border:1px solid rgba(0,0,0,0.22);
            background:rgba(255,255,255,0.88);
            font-size:12px; font-weight:900;
            cursor:pointer;">
          ìª½ì§€í•¨
        </button>

        <button id="dmCloseBtn"
          style="
            width:28px; height:28px;
            border-radius:10px;
            border:1px solid rgba(0,0,0,0.22);
            background:rgba(255,255,255,0.88);
            cursor:pointer;">
          âœ•
        </button>
      </div>
    </div>

    <!-- ë³¸ë¬¸ -->
    <div style="padding:10px; height:calc(100% - 40px); display:flex; flex-direction:column; gap:10px;">

      <!-- ì•ˆë‚´ -->
      <div id="dmInfo"
        style="
          font-size:12px; line-height:1.35;
          color:rgba(0,0,0,0.65);
          background:rgba(255,255,255,0.55);
          border:1px solid rgba(0,0,0,0.12);
          padding:8px 10px;
          border-radius:12px;">
        ì»¨íƒ/ìª½ì§€ëŠ” ì—¬ê¸°ì„œ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤. <b>ë‹‰ë„¤ì„</b>ë§Œ ìˆìœ¼ë©´ ë.
      </div>

      <!-- íƒ­ -->
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="dmModeCompose"
          style="height:32px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.22); background:rgba(255,255,255,0.92); font-weight:900; font-size:12px; cursor:pointer;">
          ë³´ë‚´ê¸°
        </button>
        <button id="dmModeInbox"
          style="height:32px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.22); background:rgba(255,255,255,0.75); font-weight:900; font-size:12px; cursor:pointer;">
          ë°›ì€í•¨
        </button>
        <button id="dmModeSent"
          style="height:32px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.22); background:rgba(255,255,255,0.75); font-weight:900; font-size:12px; cursor:pointer;">
          ë³´ë‚¸í•¨
        </button>
        <button id="dmRefresh"
          style="height:32px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.22); background:rgba(255,255,255,0.75); font-weight:900; font-size:12px; cursor:pointer;">
          ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <!-- ë³´ë‚´ê¸° í¼ -->
      <div id="dmCompose" style="display:grid; gap:8px;">
        <div style="display:grid; gap:6px;">
          <div style="font-size:12px; font-weight:900; color:rgba(0,0,0,0.65);">ë‚´ ë‹‰ë„¤ì„</div>
          <input id="dm2Nick"
            placeholder="ì˜ˆ: DearMiracle / ã…‡ã…‡ / ë‹‰ë„¤ì„"
            maxlength="30"
            style="width:100%; border-radius:12px; border:1px solid rgba(0,0,0,0.18); background:rgba(255,255,255,0.90); padding:10px 12px; font-size:14px; outline:none;">
        </div>

        <div style="display:grid; gap:6px;">
          <div style="font-size:12px; font-weight:900; color:rgba(0,0,0,0.65);">ë°›ëŠ” ì‚¬ëŒ</div>
          <input id="dm2To"
            placeholder="ìƒëŒ€ ë‹‰ë„¤ì„(ì •í™•íˆ)"
            maxlength="30"
            style="width:100%; border-radius:12px; border:1px solid rgba(0,0,0,0.18); background:rgba(255,255,255,0.90); padding:10px 12px; font-size:14px; outline:none;">
        </div>

        <div style="display:grid; gap:6px;">
          <div style="font-size:12px; font-weight:900; color:rgba(0,0,0,0.65);">ë‚´ìš©</div>
          <textarea id="dm2Body"
            placeholder="ì»¨íƒ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”."
            style="width:100%; min-height:140px; resize:vertical; border-radius:12px; border:1px solid rgba(0,0,0,0.18); background:rgba(255,255,255,0.90); padding:10px 12px; font-size:14px; outline:none; line-height:1.45;"></textarea>
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
          <button id="dmSaveNick"
            style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.22); background:rgba(255,255,255,0.88); font-weight:900; font-size:12px; cursor:pointer;">
            ë‹‰ ì €ì¥
          </button>
          <button id="dm2Send"
            style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.22); background:rgba(0,0,0,0.78); color:#fff; font-weight:900; font-size:12px; cursor:pointer;">
            ë³´ë‚´ê¸°
          </button>
        </div>

        <div id="dm2Hint" style="font-size:11px; color:rgba(0,0,0,0.65); line-height:1.35;"></div>
      </div>

      <!-- ë¦¬ìŠ¤íŠ¸(ë°›ì€/ë³´ë‚¸) -->
      <div id="dmListWrap" style="display:none; flex:1; overflow:auto; padding-right:4px;">
        <div id="dmList"></div>
        <div id="dmListHint" style="margin-top:8px; font-size:11px; color:rgba(0,0,0,0.65);"></div>
      </div>

    </div>
  </div>

  <!-- âœ… ë‹‰ë„¤ì„ ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="nickBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">ë‹‰ë„¤ì„ ì…ë ¥</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closeNick" title="ë‹«ê¸°"></button>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <div class="label">ë‹‰ë„¤ì„</div>
          <input id="nickInput" placeholder="ì˜ˆ: DearMiracle / ã…‡ã…‡ / ë‹‰ë„¤ì„" maxlength="30" />
        </div>
        <div class="modal-actions">
          <button class="pill" id="nickCancel">ì·¨ì†Œ</button>
          <button class="pill" id="nickSave">í™•ì¸</button>
        </div>
        <div class="hint">
          ë¹„ë°€ë²ˆí˜¸ ì—†ì´ <b>ë‹‰ë„¤ì„ë§Œ</b> ì‚¬ìš©í•©ë‹ˆë‹¤.<br/>
          (ê°€ê°œì¥ìš© Â· ê°„í¸ ëª¨ë“œ)
        </div>
        <div class="hint" id="nickHint"></div>
      </div>
    </div>
  </div>

  <!-- âœ… ê´€ë¦¬ì ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="adminBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">ê´€ë¦¬ì ì½”ë“œ</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closeAdmin" title="ë‹«ê¸°"></button>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <div class="label">ì½”ë“œ</div>
          <input id="adminInput" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥" />
        </div>
        <div class="modal-actions">
          <button class="pill" id="adminOff">ê´€ë¦¬ í•´ì œ</button>
          <button class="pill" id="adminOn">í™•ì¸</button>
        </div>
        <div class="hint" id="adminHint"></div>
      </div>
    </div>
  </div>

  <!-- âœ… ê¸€ì“°ê¸°/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="postBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title" id="postModalTitle">ìƒˆ ê¸€</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closePost" title="ë‹«ê¸°"></button>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <div class="label">ì œëª©</div>
          <input id="inpTitle" placeholder="ì˜ˆ: ê´€ê³„ êµ¬í•©ë‹ˆë‹¤ / ì„ ê´€ê³„ êµ¬ì¸ / 00í˜ì–´" maxlength="80" />
        </div>

        <div class="field">
          <div class="label">ì‘ì„±ì(ìë™)</div>
          <input id="inpAuthor" readonly />
        </div>

        <div class="field">
          <div class="label">ë‚´ìš©</div>
          <textarea id="inpContent" placeholder="êµ¬ì¸ ë‚´ìš© / ì¡°ê±´ / ê¸°ê°„ / ì—°ë½ ë°©ì‹ ë“±ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
        </div>

        <div class="modal-actions">
          <button class="pill" id="postCancel">ì·¨ì†Œ</button>
          <button class="pill" id="postSubmit">ë“±ë¡</button>
        </div>
        <div class="hint" id="postHint"></div>
      </div>
    </div>
  </div>

  <!-- âœ… ë³´ë“œ ê¸°ë³¸: ìª½ì§€ ë³´ë‚´ê¸° ëª¨ë‹¬ (ê²Œì‹œê¸€ì—ì„œ 'ìª½ì§€ ë³´ë‚´ê¸°' ëˆ„ë¥¼ ë•Œ) -->
  <div class="modal-backdrop" id="dmBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">ìª½ì§€ ë³´ë‚´ê¸°</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closeDM" title="ë‹«ê¸°"></button>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <div class="label">ë°›ëŠ” ì‚¬ëŒ</div>
          <input id="dmTo" readonly />
        </div>
        <div class="field">
          <div class="label">ë³´ë‚´ëŠ” ì‚¬ëŒ</div>
          <input id="dmFrom" readonly />
        </div>
        <div class="field">
          <div class="label">ë‚´ìš©</div>
          <textarea id="dmBody" placeholder="ì»¨íƒ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
        </div>

        <div class="modal-actions">
          <button class="pill" id="dmCancel">ì·¨ì†Œ</button>
          <button class="pill" id="dmSend">ë³´ë‚´ê¸°</button>
        </div>
        <div class="hint" id="dmHint"></div>
      </div>
    </div>
  </div>

  <!-- âœ… ë³´ë“œ ê¸°ë³¸: ìª½ì§€í•¨ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="inboxBg">
    <div class="modal">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">ë‚´ ìª½ì§€í•¨</div>
        </div>
        <div class="title-btns">
          <button class="btn" id="closeInbox" title="ë‹«ê¸°"></button>
        </div>
      </div>

      <div class="content">
        <div class="tabs">
          <button class="tab active" id="tabRecv">ë°›ì€ ìª½ì§€</button>
          <button class="tab" id="tabSent">ë³´ë‚¸ ìª½ì§€</button>
          <button class="pill" id="inboxRefresh">ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div id="inboxList" style="max-height: 520px; overflow:auto; padding-right:4px;"></div>
        <div class="hint" id="inboxHint"></div>
      </div>
    </div>
  </div>
<!-- =========================
       âœ… Firebase + Board Script
       ========================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, limit,
      serverTimestamp, doc, updateDoc, deleteDoc, where
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA1PxEOrwjVi4BOLA13UbFIncTYe6RdYIQ",
      authDomain: "dear-miracle.firebaseapp.com",
      projectId: "dear-miracle",
      storageBucket: "dear-miracle.firebasestorage.app",
      messagingSenderId: "793139917614",
      appId: "1:793139917614:web:dec74f65af6a0df1c740bf",
      measurementId: "G-VF22L8ZR6D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // âœ… ì¹´í†¡í˜• ë©”ì‹ ì €(ì¼ë°˜ script)ì—ì„œë„ Firestore ì“°ê²Œ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    window.db = db;
    window.__fb = { collection, addDoc, getDocs, query, where, orderBy, limit, serverTimestamp };

    const $ = (id)=>document.getElementById(id);

    function fmtTime(ts){
      if(!ts) return "";
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const yy = String(d.getFullYear()).slice(2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${yy}.${mm}.${dd} ${hh}:${mi}`;
      }catch{
        return "";
      }
    }

    function setStatus(msg){
      $("status").textContent = msg || "";
    }

    // --- ë³´ë“œ ìœˆë„ìš°: ì²˜ìŒ ë¡œë”©/ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¤‘ì•™ ë°°ì¹˜(ì‚¬ìš©ìê°€ ë“œë˜ê·¸í–ˆìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    let boardUserMoved = false;

    function centerBoardWin(){
      const win = document.getElementById("boardWin");
      if(!win) return;
      if(boardUserMoved) return;

      const vw = window.innerWidth;

      // í™”ë©´ í­ì— ë§ì¶° ìœˆë„ìš° í­ì„ ì ë‹¹íˆ ì œí•œ
      const targetW = Math.min(1180, vw - 24);
      win.style.width = targetW + "px";

      const left = Math.max(12, Math.round((vw - targetW) / 2));
      const top  = 50;

      win.style.left = left + "px";
      win.style.top  = top + "px";
    }

    // ë“œë˜ê·¸ë¡œ ì›€ì§ì˜€ìœ¼ë©´ ì´í›„ ìë™ì¤‘ì•™ì •ë ¬ ë”
    (function hookBoardDragFlag(){
      const win = document.getElementById("boardWin");
      if(!win) return;
      const bar = win.querySelector(".titlebar");
      if(!bar) return;

      bar.addEventListener("pointerdown", (e)=>{
        const t = e.target;
        if(t && (t.tagName === "BUTTON" || t.classList.contains("btn") || t.classList.contains("iconbtn"))) return;
        boardUserMoved = true;
      });
    })();

    // =========================
    // âœ… ë‹‰ë„¤ì„(ì¸ë±ìŠ¤ì™€ ê³µìœ )
    // =========================
    const NICK_KEY = "dm_nick";
    const READ_KEY_PREFIX = "dm_read_cutoff_"; // dm_read_cutoff_<nick>

    function getNick(){ return (localStorage.getItem(NICK_KEY) || "").trim(); }
    function setNick(n){ localStorage.setItem(NICK_KEY, (n||"").trim()); }

    function getReadCutoff(nick){
      const raw = localStorage.getItem(READ_KEY_PREFIX + nick);
      const ms = raw ? parseInt(raw, 10) : 0;
      return Number.isFinite(ms) ? ms : 0;
    }
    function setReadCutoff(nick, ms){
      localStorage.setItem(READ_KEY_PREFIX + nick, String(ms));
    }

    // =========================
    // âœ… ê´€ë¦¬ì(ë§ˆìŠ¤í„°í‚¤) ëª¨ë“œ
    // =========================
    const ADMIN_KEY = "dm_is_admin";
    const ADMIN_MASTER_CODE = "xhltk";

    function isAdmin(){ return localStorage.getItem(ADMIN_KEY) === "1"; }
    function setAdmin(on){
      localStorage.setItem(ADMIN_KEY, on ? "1" : "0");
      updateWhoAmI();
    }
    function adminBadge(){ return isAdmin() ? " Â· ê´€ë¦¬ì" : ""; }

    function updateWhoAmI(){
      const n = getNick();
      $("whoami").textContent = n ? `ë‹‰ë„¤ì„: ${n}${adminBadge()}` : `ë‹‰ë„¤ì„: (ì—†ìŒ)${adminBadge()}`;
      $("inpAuthor").value = n || "";
      $("dmFrom").value = n || "";
    }

    // =========================
    // âœ… ë‹‰ ëª¨ë‹¬
    // =========================
    const nickBg = $("nickBg");
    function openNickModal(force=false){
      $("nickHint").textContent = "";
      $("nickInput").value = getNick();
      nickBg.style.display = "flex";
      $("closeNick").style.display = force ? "none" : "inline-flex";
      setTimeout(()=> $("nickInput").focus(), 50);
    }
    function closeNickModal(){ nickBg.style.display = "none"; }
    function ensureNick(){
      const n = getNick();
      if(!n){ openNickModal(true); return false; }
      return true;
    }

    $("nickSave").onclick = async ()=>{
      const val = ($("nickInput").value || "").trim();
      if(!val){ $("nickHint").textContent = "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }
      setNick(val);
      updateWhoAmI();
      closeNickModal();
      await loadPosts();
      await refreshInboxBadge();
    };
    $("nickCancel").onclick = ()=>{
      if(getNick()) closeNickModal();
      else $("nickHint").textContent = "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì•¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    };
    $("closeNick").onclick = closeNickModal;
    nickBg.addEventListener("click", (e)=>{ if(e.target===nickBg && getNick()) closeNickModal(); });

    // =========================
    // âœ… ê´€ë¦¬ì ëª¨ë‹¬
    // =========================
    const adminBg = $("adminBg");
    function openAdminModal(){
      $("adminHint").textContent = "";
      $("adminInput").value = "";
      adminBg.style.display = "flex";
      setTimeout(()=> $("adminInput").focus(), 50);
    }
    function closeAdminModal(){ adminBg.style.display = "none"; }

    $("btnAdmin").onclick = openAdminModal;
    $("closeAdmin").onclick = closeAdminModal;
    adminBg.addEventListener("click", (e)=>{ if(e.target===adminBg) closeAdminModal(); });

    $("adminOn").onclick = ()=>{
      const code = ($("adminInput").value || "").trim();
      if(code === ADMIN_MASTER_CODE){
        setAdmin(true);
        closeAdminModal();
        loadPosts();
      }else{
        $("adminHint").textContent = "ê´€ë¦¬ì ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    };
    $("adminOff").onclick = ()=>{
      setAdmin(false);
      closeAdminModal();
      loadPosts();
    };

    // =========================
    // âœ… ë„¤ë¹„
    // =========================
    const goHome = ()=> location.href = "index.html";
    $("homeBtn").onclick = goHome;
    $("btnHome").onclick = goHome;
    $("btnReload").onclick = ()=> location.reload();
    $("btnNick").onclick = ()=> openNickModal(false);
    $("changeNickBtn").onclick = ()=> openNickModal(false);

    // =========================
    // âœ… ê¸€ì“°ê¸°/ìˆ˜ì • ëª¨ë‹¬
    // =========================
    const postBg = $("postBg");
    let editingPostId = null;

    function openPostModal(mode="new", post=null){
      if(!ensureNick()) return;

      $("postHint").textContent = "";
      if(mode==="edit" && post){
        editingPostId = post.id;
        $("postModalTitle").textContent = "ê¸€ ìˆ˜ì •";
        $("postSubmit").textContent = "ìˆ˜ì •";
        $("inpTitle").value = post.title || "";
        $("inpContent").value = post.content || "";
      }else{
        editingPostId = null;
        $("postModalTitle").textContent = "ìƒˆ ê¸€";
        $("postSubmit").textContent = "ë“±ë¡";
        $("inpTitle").value = "";
        $("inpContent").value = "";
      }
      $("inpAuthor").value = getNick();
      postBg.style.display = "flex";
      setTimeout(()=> $("inpTitle").focus(), 50);
    }
    function closePostModal(){ postBg.style.display = "none"; }

    $("writeBtn").onclick = ()=> openPostModal("new");
    $("btnWrite").onclick = ()=> openPostModal("new");
    $("postCancel").onclick = closePostModal;
    $("closePost").onclick = closePostModal;
    postBg.addEventListener("click", (e)=>{ if(e.target===postBg) closePostModal(); });

    $("postSubmit").onclick = async ()=>{
      if(!ensureNick()) return;

      const title = ($("inpTitle").value || "").trim();
      const content = ($("inpContent").value || "").trim();
      const author = getNick();

      if(!title){ $("postHint").textContent = "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }
      if(!content){ $("postHint").textContent = "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }

      try{
        $("postSubmit").disabled = true;
        $("postHint").textContent = "ì €ì¥ ì¤‘â€¦";

        if(editingPostId){
          const ref = doc(db, "posts", editingPostId);
          await updateDoc(ref, { title, content, updatedAt: serverTimestamp() });
        }else{
          await addDoc(collection(db, "posts"), {
            title, content, author,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }

        closePostModal();
        await loadPosts();
      }catch(err){
        console.error(err);
        $("postHint").textContent = "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      }finally{
        $("postSubmit").disabled = false;
      }
    };

    // =========================
    // âœ… ë³´ë“œ ê¸°ë³¸: ìª½ì§€ ë³´ë‚´ê¸° ëª¨ë‹¬
    // =========================
    const dmBg = $("dmBg");
    let dmTargetNick = "";
    let dmTargetPostId = "";

    function openDMModal(toNick, postId=""){
      if(!ensureNick()) return;
      dmTargetNick = (toNick || "").trim();
      dmTargetPostId = (postId || "").trim();

      $("dmHint").textContent = "";
      $("dmTo").value = dmTargetNick;
      $("dmFrom").value = getNick();
      $("dmBody").value = "";
      dmBg.style.display = "flex";
      setTimeout(()=> $("dmBody").focus(), 50);
    }
    function closeDMModal(){ dmBg.style.display = "none"; }

    $("closeDM").onclick = closeDMModal;
    $("dmCancel").onclick = closeDMModal;
    dmBg.addEventListener("click", (e)=>{ if(e.target===dmBg) closeDMModal(); });

    $("dmSend").onclick = async ()=>{
      if(!ensureNick()) return;

      const from = getNick();
      const to = (dmTargetNick || "").trim();
      const body = ($("dmBody").value || "").trim();

      if(!to){ $("dmHint").textContent = "ë°›ëŠ” ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤."; return; }
      if(to === from){ $("dmHint").textContent = "ìê¸° ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; return; }
      if(!body){ $("dmHint").textContent = "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }

      try{
        $("dmSend").disabled = true;
        $("dmHint").textContent = "ì „ì†¡ ì¤‘â€¦";

        await addDoc(collection(db, "messages"), {
          from, to, body,
          postId: dmTargetPostId || "",
          createdAt: serverTimestamp()
        });

        closeDMModal();
        await refreshInboxBadge();
      }catch(err){
        console.error(err);
        $("dmHint").textContent = "ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      }finally{
        $("dmSend").disabled = false;
      }
    };

    // =========================
    // âœ… ë³´ë“œ ìƒë‹¨ ìª½ì§€ ë±ƒì§€
    // =========================
    function updateInboxBadge(n){
      const b = $("inboxBadge");
      const num = Math.max(0, Number(n)||0);
      b.textContent = String(num);
      b.style.display = num > 0 ? "inline-flex" : "none";
    }

    function markReadNow(){
      const me = getNick();
      if(!me) return;
      setReadCutoff(me, Date.now());
      updateInboxBadge(0);
    }

    async function refreshInboxBadge(){
      const me = getNick();
      if(!me){ updateInboxBadge(0); return; }

      const cutoffMs = getReadCutoff(me);

      try{
        // âœ… orderBy ì œê±°: Firestore ë³µí•© ì¸ë±ìŠ¤ ì—†ì´ë„ ë™ì‘ (ì •ë ¬ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
        const qy = query(
          collection(db, "messages"),
          where("to", "==", me),
          limit(200)
        );
        const snap = await getDocs(qy);

        let cnt = 0;
        snap.forEach(docu=>{
          const m = docu.data();
          const t = m.createdAt?.toDate ? m.createdAt.toDate().getTime() : 0;
          if(t && t > cutoffMs) cnt += 1;
        });

        updateInboxBadge(cnt);
      }catch(err){
        console.error(err);
      }
    }

    // =========================
    // âœ… ìª½ì§€í•¨ ëª¨ë‹¬
    // =========================
    const inboxBg = $("inboxBg");
    let inboxMode = "recv"; // recv | sent

    function openInbox(){
      if(!ensureNick()) return;
      inboxBg.style.display = "flex";
      setInboxTab("recv");
      loadInbox();
      markReadNow();
    }
    function closeInbox(){ inboxBg.style.display = "none"; }

    function setInboxTab(mode){
      inboxMode = mode;
      $("tabRecv").classList.toggle("active", mode==="recv");
      $("tabSent").classList.toggle("active", mode==="sent");
    }

    $("inboxBtn").onclick = openInbox;
    $("btnInbox").onclick = openInbox;
    $("closeInbox").onclick = closeInbox;
    inboxBg.addEventListener("click", (e)=>{ if(e.target===inboxBg) closeInbox(); });

    $("tabRecv").onclick = ()=>{ setInboxTab("recv"); loadInbox(); };
    $("tabSent").onclick = ()=>{ setInboxTab("sent"); loadInbox(); };
    $("inboxRefresh").onclick = ()=> loadInbox();

    async function loadInbox(){
      if(!ensureNick()) return;

      const me = getNick();
      const cutoffMs = getReadCutoff(me);

      $("inboxHint").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
      $("inboxList").innerHTML = "";

      try{
        // âœ… orderBy ì œê±°: ë³µí•© ì¸ë±ìŠ¤ ì—†ì´ë„ ë™ì‘ (ì •ë ¬ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
        const qy = (inboxMode === "recv")
          ? query(
              collection(db, "messages"),
              where("to", "==", me),
              limit(200)
            )
          : query(
              collection(db, "messages"),
              where("from", "==", me),
              limit(200)
            );

        const snap = await getDocs(qy);

        if(snap.empty){
          $("inboxHint").textContent = inboxMode==="recv" ? "ë°›ì€ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤." : "ë³´ë‚¸ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        // âœ… createdAt ê¸°ì¤€ìœ¼ë¡œ ìµœì‹ ìˆœ ì •ë ¬
        const items = [];
        snap.forEach(docu=>{
          const m = docu.data();
          const whenMs = m.createdAt?.toDate ? m.createdAt.toDate().getTime() : 0;
          items.push({ ...m, __whenMs: whenMs });
        });
        items.sort((a,b)=> (b.__whenMs||0) - (a.__whenMs||0));

        const frag = document.createDocumentFragment();

        items.forEach(m=>{
          const div = document.createElement("div");
          div.className = "msg";

          const top = document.createElement("div");
          top.className = "top";

          const who = inboxMode==="recv"
            ? `ë³´ë‚¸ ì‚¬ëŒ: ${m.from || "-"}`
            : `ë°›ëŠ” ì‚¬ëŒ: ${m.to || "-"}`;

          const t = fmtTime(m.createdAt);

          const isUnread = inboxMode==="recv" && m.__whenMs && m.__whenMs > cutoffMs;

          const ref = m.postId ? `ì—°ê²°ê¸€: ${m.postId}` : "";
          top.textContent = `${who} Â· ${t}${isUnread ? " Â· ì•ˆì½ìŒ" : ""}${ref ? " Â· " + ref : ""}`;

          const body = document.createElement("div");
          body.className = "body";
          body.textContent = m.body || "";

          div.appendChild(top);
          div.appendChild(body);

          // âœ… ë°›ì€í•¨ì€ ë‹µì¥ ë²„íŠ¼
          if(inboxMode === "recv"){
            const actions = document.createElement("div");
            actions.className = "actions";

            const reply = document.createElement("button");
            reply.className = "mini";
            reply.textContent = "ë‹µì¥";
            reply.onclick = ()=> openDMModal(m.from || "", m.postId || "");

            actions.appendChild(reply);
            div.appendChild(actions);
          }

          frag.appendChild(div);
        });

        $("inboxList").appendChild(frag);
        $("inboxHint").textContent = "";

        markReadNow();
        await refreshInboxBadge();
      }catch(err){
        console.error(err);
        $("inboxHint").textContent = "ìª½ì§€í•¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
      }
    }

    // =========================
    // âœ… ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ/ë Œë”
    // =========================
    async function loadPosts(){
      setStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");
      $("list").innerHTML = "";

      try{
        const qy = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(50));
        const snap = await getDocs(qy);

        if(snap.empty){
          setStatus("ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”.");
          return;
        }

        const me = getNick();
        const admin = isAdmin();

        const frag = document.createDocumentFragment();

        snap.forEach(docu=>{
          const p = docu.data();
          const id = docu.id;

          const card = document.createElement("div");
          card.className = "card";

          const h = document.createElement("h3");
          h.textContent = p.title || "(ì œëª© ì—†ìŒ)";

          const meta = document.createElement("div");
          meta.className = "meta";
          const author = p.author || "-";
          const created = fmtTime(p.createdAt);
          const updated = fmtTime(p.updatedAt);
          meta.textContent = `ì‘ì„±ì: ${author} Â· ì‘ì„±: ${created}${updated ? " Â· ìˆ˜ì •: " + updated : ""}`;

          const text = document.createElement("div");
          text.className = "text";
          text.textContent = p.content || "";

          const actions = document.createElement("div");
          actions.className = "card-actions";

          const btnDM = document.createElement("button");
          btnDM.className = "mini";
          btnDM.textContent = "ìª½ì§€ ë³´ë‚´ê¸°";
          btnDM.onclick = ()=> openDMModal(author, id);
          actions.appendChild(btnDM);

          const canManage = (me && author === me) || admin;

          if(canManage){
            const btnEdit = document.createElement("button");
            btnEdit.className = "mini ghost";
            btnEdit.textContent = "ìˆ˜ì •";
            btnEdit.onclick = ()=> openPostModal("edit", { id, title: p.title, content: p.content });

            const btnDel = document.createElement("button");
            btnDel.className = "mini danger";
            btnDel.textContent = "ì‚­ì œ";
            btnDel.onclick = async ()=>{
              const ok = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
              if(!ok) return;
              try{
                await deleteDoc(doc(db, "posts", id));
                await loadPosts();
              }catch(err){
                console.error(err);
                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            };

            actions.appendChild(btnEdit);
            actions.appendChild(btnDel);
          }

          card.appendChild(h);
          card.appendChild(meta);
          card.appendChild(text);
          card.appendChild(actions);

          frag.appendChild(card);
        });

        $("list").appendChild(frag);
        setStatus("");
      }catch(err){
        console.error(err);
        setStatus("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // =========================
    // âœ… ì°½ ë“œë˜ê·¸ + ì•ìœ¼ë¡œ
    // =========================
    const wins = Array.from(document.querySelectorAll(".win"));
    let topZ = 100;

    function bringToFront(win){
      topZ += 1;
      win.style.zIndex = topZ;
      wins.forEach(w => w.classList.remove("is-front"));
      win.classList.add("is-front");
    }

    wins.forEach(win => {
      const initZ = parseInt(win.getAttribute("data-z") || "0", 10);
      win.style.zIndex = 50 + initZ;

      win.addEventListener("pointerdown", () => bringToFront(win));

      const bar = win.querySelector(".titlebar");
      if(!bar) return;

      let dragging = false;
      let startX = 0, startY = 0, winX = 0, winY = 0;

      bar.addEventListener("pointerdown", (e) => {
        const t = e.target;
        if(t && (t.tagName === "BUTTON" || t.classList.contains("btn") || t.classList.contains("iconbtn"))) return;

        bringToFront(win);
        dragging = true;
        bar.setPointerCapture(e.pointerId);

        const rect = win.getBoundingClientRect();
        startX = e.clientX; startY = e.clientY;
        winX = rect.left;  winY = rect.top;
        e.preventDefault();
      });

      bar.addEventListener("pointermove", (e) => {
        if(!dragging) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let nx = winX + dx;
        let ny = winY + dy;

        const maxX = window.innerWidth - 60;
        const maxY = window.innerHeight - 120;
        nx = Math.min(Math.max(nx, -40), maxX);
        ny = Math.min(Math.max(ny, -20), maxY);

        win.style.left = nx + "px";
        win.style.top  = ny + "px";
      });

      bar.addEventListener("pointerup", () => dragging = false);
      bar.addEventListener("pointercancel", () => dragging = false);
    });

    // =========================
    // âœ… ì´ˆê¸° ì‹¤í–‰
    // =========================
    updateWhoAmI();

    centerBoardWin();
    window.addEventListener("resize", centerBoardWin);

    if(!getNick()){
      openNickModal(true);
    }else{
      await loadPosts();
      await refreshInboxBadge();
    }

    // âœ… ë±ƒì§€ 15ì´ˆë§ˆë‹¤ ê°±ì‹ (ê°€ë²¼ìš´ í´ë§)
    setInterval(()=>{ refreshInboxBadge(); }, 15000);
  </script>

  <script>
  /* =========================
     âœ… ì¹´í†¡í˜• ë©”ì‹ ì € JS (ë³´ë“œìš© 1ì„¸íŠ¸)
     - Firestore: messages ì»¬ë ‰ì…˜ ì‚¬ìš©
     - localStorage: dm_nick ê³µìœ 
     - ì•ˆì½ìŒ ë±ƒì§€: dm_read_cutoff_<nick>
     - ë³´ë“œ ê¸°ë³¸ dmTo/dmBody/dmSendì™€ ì¶©ëŒ ë°©ì§€: dm2*
     ========================= */

  (function(){
    const $ = (id)=>document.getElementById(id);

    // Firebase ë¡œë”©(ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸)ë³´ë‹¤ ì´ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¨¼ì € ì‹¤í–‰ë  ìˆ˜ ìˆìŒ.
// ê·¸ë˜ì„œ window.db / window.__fbê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë©”ì‹ ì €ë¥¼ ì´ˆê¸°í™”í•œë‹¤.
function waitForFirebase(tries=0){
  const db = window.db;
  const fb = window.__fb;
  if(db && fb && fb.collection){
    initMessenger(db, fb);
    return;
  }
  if(tries > 200){ // ~10ì´ˆ(50ms * 200)
    console.warn("âŒ Firebase ì¤€ë¹„ ì‹¤íŒ¨: ë©”ì‹ ì € ì´ˆê¸°í™” ì¤‘ë‹¨");
    return;
  }
  setTimeout(()=>waitForFirebase(tries+1), 50);
}

function initMessenger(db, fb){
  const { collection, addDoc, getDocs, query, where, orderBy, limit, serverTimestamp } = fb;

const NICK_KEY = "dm_nick";
    const READ_KEY_PREFIX = "dm_read_cutoff_";

    function getNick(){ return (localStorage.getItem(NICK_KEY) || "").trim(); }
    function setNick(n){ localStorage.setItem(NICK_KEY, (n||"").trim()); }

    function getReadCutoff(nick){
      const raw = localStorage.getItem(READ_KEY_PREFIX + nick);
      const ms = raw ? parseInt(raw, 10) : 0;
      return Number.isFinite(ms) ? ms : 0;
    }
    function setReadCutoff(nick, ms){
      localStorage.setItem(READ_KEY_PREFIX + nick, String(ms));
    }

    function fmtTime(ts){
      if(!ts) return "";
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const yy = String(d.getFullYear()).slice(2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${yy}.${mm}.${dd} ${hh}:${mi}`;
      }catch{
        return "";
      }
    }

    // UI refs
    const fab = $("dmFabBtn");
    const win = $("dmWin");
    const closeBtn = $("dmCloseBtn");
    const badge = $("dmBadge");

    const modeCompose = $("dmModeCompose");
    const modeInbox = $("dmModeInbox");
    const modeSent = $("dmModeSent");
    const refreshBtn = $("dmRefresh");

    const compose = $("dmCompose");
    const listWrap = $("dmListWrap");
    const list = $("dmList");
    const listHint = $("dmListHint");

    // âœ… dm2* (ì¶©ëŒ ë°©ì§€)
    const inpNick = $("dm2Nick");
    const inpTo = $("dm2To");
    const inpBody = $("dm2Body");
    const btnSend = $("dm2Send");
    const hint = $("dm2Hint");
    const btnSaveNick = $("dmSaveNick");

    let mode = "compose"; // compose | inbox | sent

    function setMode(m){
      mode = m;
      const activeStyle = "rgba(255,255,255,0.92)";
      const idleStyle = "rgba(255,255,255,0.75)";
      modeCompose.style.background = (m==="compose") ? activeStyle : idleStyle;
      modeInbox.style.background   = (m==="inbox") ? activeStyle : idleStyle;
      modeSent.style.background    = (m==="sent") ? activeStyle : idleStyle;

      compose.style.display = (m==="compose") ? "grid" : "none";
      listWrap.style.display = (m==="compose") ? "none" : "block";
    }

    function openWin(){
      win.style.display = "block";
      setMode("compose");
      hint.textContent = "";
      inpNick.value = getNick();
      refreshBadge();
    }
    function closeWin(){
      win.style.display = "none";
    }

    fab?.addEventListener("click", ()=>{
      if(win.style.display === "none" || !win.style.display) openWin();
      else closeWin();
    });
    closeBtn?.addEventListener("click", closeWin);

    $("dmTabBtn")?.addEventListener("click", ()=>{
      setMode("inbox");
      loadList();
      markReadNow();
    });

    modeCompose?.addEventListener("click", ()=> setMode("compose"));
    modeInbox?.addEventListener("click", ()=>{ setMode("inbox"); loadList(); markReadNow(); });
    modeSent?.addEventListener("click", ()=>{ setMode("sent"); loadList(); });
    refreshBtn?.addEventListener("click", ()=>{
      if(mode==="compose") refreshBadge();
      else loadList();
    });

    btnSaveNick?.addEventListener("click", ()=>{
      const n = (inpNick.value||"").trim();
      if(!n){ hint.textContent = "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜."; return; }
      setNick(n);
      hint.textContent = "ë‹‰ ì €ì¥ ì™„ë£Œ!";
      refreshBadge();
    });

    async function sendDM(){
      const from = (inpNick.value||"").trim();
      const to = (inpTo.value||"").trim();
      const body = (inpBody.value||"").trim();

      if(!from){ hint.textContent = "ë‚´ ë‹‰ë„¤ì„ë¶€í„° ì…ë ¥í•´ì¤˜."; return; }
      if(!to){ hint.textContent = "ë°›ëŠ” ì‚¬ëŒ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜."; return; }
      if(from === to){ hint.textContent = "ìê¸° ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ì–´."; return; }
      if(!body){ hint.textContent = "ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜."; return; }

      try{
        btnSend.disabled = true;
        hint.textContent = "ì „ì†¡ ì¤‘â€¦";

        setNick(from);
        await addDoc(collection(db, "messages"), {
          from, to, body,
          postId: "",
          createdAt: serverTimestamp()
        });

        inpBody.value = "";
        hint.textContent = "ì „ì†¡ ì™„ë£Œ!";
        await refreshBadge();
      }catch(e){
        console.error(e);
        hint.textContent = "ì „ì†¡ ì‹¤íŒ¨â€¦ (ì½˜ì†” í™•ì¸)";
      }finally{
        btnSend.disabled = false;
      }
    }

    btnSend?.addEventListener("click", sendDM);

    function updateBadge(n){
      const num = Math.max(0, Number(n)||0);
      badge.textContent = String(num);
      badge.style.display = num > 0 ? "inline-flex" : "none";
    }

    function markReadNow(){
      const me = getNick();
      if(!me) return;
      setReadCutoff(me, Date.now());
      updateBadge(0);
    }

    async function refreshBadge(){
      const me = getNick();
      if(!me){ updateBadge(0); return; }
      const cutoff = getReadCutoff(me);

      try{
        // âœ… orderBy ì œê±°: ë³µí•© ì¸ë±ìŠ¤ ì—†ì´ë„ ë™ì‘ (ì •ë ¬ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
        const qy = query(
          collection(db, "messages"),
          where("to", "==", me),
          limit(200)
        );
        const snap = await getDocs(qy);

        let cnt = 0;
        snap.forEach(d=>{
          const m = d.data();
          const t = m.createdAt?.toDate ? m.createdAt.toDate().getTime() : 0;
          if(t && t > cutoff) cnt += 1;
        });

        updateBadge(cnt);
      }catch(e){
        console.error(e);
      }
    }

    async function loadList(){
      const me = getNick();
      if(!me){
        listHint.textContent = "ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•´ì¤˜.";
        list.innerHTML = "";
        return;
      }

      listHint.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
      list.innerHTML = "";

      try{
        // âœ… orderBy ì œê±°: ë³µí•© ì¸ë±ìŠ¤ ì—†ì´ë„ ë™ì‘ (ì •ë ¬ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
        const qy = (mode === "inbox")
          ? query(
              collection(db, "messages"),
              where("to", "==", me),
              limit(200)
            )
          : query(
              collection(db, "messages"),
              where("from", "==", me),
              limit(200)
            );

        const cutoff = getReadCutoff(me);
        const snap = await getDocs(qy);

        if(snap.empty){
          listHint.textContent = (mode==="inbox") ? "ë°›ì€ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤." : "ë³´ë‚¸ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        // âœ… createdAt ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
        const items = [];
        snap.forEach(docu=>{
          const m = docu.data();
          const whenMs = m.createdAt?.toDate ? m.createdAt.toDate().getTime() : 0;
          items.push({ ...m, __whenMs: whenMs });
        });
        items.sort((a,b)=> (b.__whenMs||0) - (a.__whenMs||0));

        const frag = document.createDocumentFragment();

        items.forEach(m=>{
          const box = document.createElement("div");
          box.style.cssText = `
            background: rgba(255,255,255,0.62);
            border: 1px solid rgba(0,0,0,0.14);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
          `;

          const top = document.createElement("div");
          top.style.cssText = `
            display:flex; gap:10px; flex-wrap:wrap;
            font-size:11px; color: rgba(0,0,0,0.60);
            margin-bottom: 8px;
          `;

          const who = (mode==="inbox") ? `ë³´ë‚¸ ì‚¬ëŒ: ${m.from||"-"}` : `ë°›ëŠ” ì‚¬ëŒ: ${m.to||"-"}`;
          const when = fmtTime(m.createdAt);
          const unread = (mode==="inbox") && m.__whenMs && m.__whenMs > cutoff;

          top.textContent = `${who} Â· ${when}${unread ? " Â· ì•ˆì½ìŒ" : ""}`;

          const body = document.createElement("div");
          body.style.cssText = `font-size:13px; line-height:1.45; white-space:pre-wrap; color:#222;`;
          body.textContent = m.body || "";

          box.appendChild(top);
          box.appendChild(body);

          if(mode==="inbox"){
            const actions = document.createElement("div");
            actions.style.cssText = `margin-top:10px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;`;

            const reply = document.createElement("button");
            reply.textContent = "ë‹µì¥";
            reply.style.cssText = `
              height:30px; padding:0 10px;
              border-radius:10px;
              border:1px solid rgba(0,0,0,0.22);
              background: rgba(255,255,255,0.90);
              font-weight:900;
              font-size:12px;
              cursor:pointer;
            `;
            reply.onclick = ()=>{
              setMode("compose");
              inpTo.value = (m.from||"").trim();
              inpBody.focus();
            };

            actions.appendChild(reply);
            box.appendChild(actions);
          }

          frag.appendChild(box);
        });

        list.appendChild(frag);
        listHint.textContent = "";

        if(mode==="inbox"){
          markReadNow();
          await refreshBadge();
        }
      }catch(e){
        console.error(e);
        listHint.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨â€¦";
      }
    }
  // ì´ˆê¸°
  inpNick.value = getNick();
  refreshBadge();
  setInterval(refreshBadge, 15000);

  }

  // ëª¨ë“ˆ Firebase ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ì‹œì‘
  waitForFirebase();

})();
  </script>
</body>
  </html>
