<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dear Miracle</title>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Tahoma, Verdana, Arial, sans-serif;
      overflow: hidden;
      background: #000;
    }

    :root{
      --titlebar-top: #f7f7f7;
      --titlebar-bot: #e9e9e9;

      --frame: rgba(255,255,255,0.60);
      --glass: rgba(255,255,255,0.40);
      --border: rgba(0,0,0,0.30);

      --shadow: 0 12px 30px rgba(0,0,0,0.22);
      --shadow-strong: 0 18px 46px rgba(0,0,0,0.30);

      --text: #1b1b1b;
      --muted: rgba(0,0,0,0.55);
    }

    .wallpaper {
      position: fixed;
      inset: 0;
      background-image: url("bg.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(0.95) contrast(0.98);
      transform: scale(1.02);
    }

    .wallpaper::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(1200px 600px at 20% 15%, rgba(255,255,255,0.30), transparent 60%),
        radial-gradient(900px 500px at 80% 25%, rgba(255,255,255,0.22), transparent 55%),
        radial-gradient(900px 700px at 55% 80%, rgba(255,255,255,0.18), transparent 60%),
        linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      pointer-events:none;
    }

    .desk {
      position: fixed;
      inset: 0;
      pointer-events: none;
    }

    .win {
      position: absolute;
      width: 420px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      background: var(--frame);

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      pointer-events: auto;
      user-select: none;
    }
    .win.is-front { box-shadow: var(--shadow-strong); }

    .titlebar {
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px 0 10px;

      background: linear-gradient(to bottom, var(--titlebar-top), var(--titlebar-bot));
      border-bottom: 1px solid rgba(0,0,0,0.18);

      color: #222;
      text-shadow: none;
      cursor: grab;
    }
    .titlebar:active { cursor: grabbing; }

    .title-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.75);
      flex: 0 0 auto;
    }

    .title {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }

    .title-btns {
      display: flex;
      gap: 6px;
      flex: 0 0 auto;
    }

    .btn {
      width: 16px;
      height: 16px;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.35);
      background: rgba(255,255,255,0.85);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.12);
    }

    .content {
      background: var(--glass);
      padding: 8px;
    }

    .media {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.35);
    }
    .media img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .meta {
      margin-top: 6px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      padding: 4px 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.12);
    }

    .note {
      padding: 10px 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.14);
      background: rgba(255,255,255,0.62);
      color: #222;
      font-size: 13px;
      line-height: 1.35;
    }
    .note b { display:block; margin-bottom: 6px; }
    .note ul { margin: 8px 0 0 18px; padding:0; }
    .note li { margin: 3px 0; }
    .note a { color:#0b57d0; text-decoration: underline; }

    .taskbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 44px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;

      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      border-top: 1px solid rgba(0,0,0,0.18);
    }

    .start {
      height: 30px;
      padding: 0 12px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.80);
      font-weight: 700;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 8px;
      cursor: pointer;
    }

    .brand {
      font-size: 13px;
      color: #222;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .spacer { flex: 1; }
    .clock {
      font-size: 12px;
      color: rgba(0,0,0,0.65);
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 480px){
      .win { width: 340px; }
      .title { max-width: 220px; }
    }

    /* ===== YouTube playlist window ===== */
    .yt-window { width: 280px; }      /* âœ… ì‚´ì§ í‚¤ì›€ */
    .yt-window .content { padding: 0; background: #fff; }
    .yt-window iframe {
      width: 100%;
      height: 190px;                  /* âœ… ì‚´ì§ í‚¤ì›€(ìŒì†Œê±° ë²„íŠ¼ ëœ¨ê²Œ) */
      border: 0;
      display: block;
    }

    .yt-window .titlebar .buttons {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .yt-window .sound-btn {
      font-size: 12px;
      padding: 2px 8px;
      border: 1px solid rgba(0,0,0,0.25);
      border-radius: 6px;
      background: rgba(255,255,255,0.85);
      cursor: pointer;
    }
    .yt-window .sound-btn:active { transform: translateY(1px); }

    /* =========================================================
       âœ… ì¸ë±ìŠ¤ ì „ìš©: ìª½ì§€ ì•„ì´ì½˜(í° ë²„íŠ¼) + ì•ˆì½ìŒ ë±ƒì§€ + ë©”ì‹ ì € ëª¨ë‹¬
       (ê¸°ì¡´ ë””ìì¸/ë ˆì´ì•„ì›ƒ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
       ========================================================= */
    .dm-fab{
      position: fixed;
      right: 18px;
      bottom: 64px; /* taskbar ìœ„ */
      z-index: 99999;
      pointer-events: auto;
    }
    .dm-fab button{
      width: 64px;
      height: 64px;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,0.25);
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 28px; /* âœ… ì•„ì´ì½˜ í¼ */
      line-height: 1;
    }
    .dm-fab button:active{ transform: translateY(1px); }

    .dm-badge{
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 26px;
      height: 26px;
      padding: 0 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.92);
      font-weight: 900;
      font-size: 13px;
      display:none;
      align-items:center;
      justify-content:center;
    }

    @media (max-width: 560px){
      .dm-fab{ right: 14px; bottom: 66px; }
      .dm-fab button{
        width: 78px;
        height: 78px;
        border-radius: 22px;
        font-size: 34px;
      }
      .dm-badge{
        min-width: 30px;
        height: 30px;
        font-size: 14px;
      }
    }

    .dm-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 99998;
      pointer-events: auto;
    }
    .dm-modal{
      width: min(840px, 100%);
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 12px;
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .dm-modal .titlebar{ cursor: default; }
    .dm-modal .content{ background: transparent; }

    .dm-head{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
      padding: 10px;
      background: rgba(255,255,255,0.55);
      border-bottom: 1px solid rgba(0,0,0,0.12);
    }
    .dm-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .dm-tab{
      height: 36px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.75);
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
    }
    .dm-tab.active{ background: rgba(255,255,255,0.92); }

    .dm-pill{
      height: 36px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.92);
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
    }
    .dm-pill:active{ transform: translateY(1px); }

    .dm-body{
      padding: 10px;
    }

    .dm-list{
      max-height: min(56vh, 520px);
      overflow:auto;
      padding-right: 4px;
    }

    .dm-msg{
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(0,0,0,0.14);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .dm-msg .top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size: 12px;
      color: rgba(0,0,0,0.60);
      margin-bottom: 8px;
    }
    .dm-msg .body{
      font-size: 14px;
      line-height: 1.55;
      white-space: pre-wrap;
      color:#222;
    }
    .dm-actions{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .dm-mini{
      height: 36px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.92);
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
    }
    .dm-mini.ghost{ background: rgba(255,255,255,0.65); }
    .dm-mini:active{ transform: translateY(1px); }

    .dm-compose{
      margin-top: 10px;
      display:none;
      gap: 8px;
    }
    .dm-compose .field{
      display:grid;
      gap: 6px;
      margin-bottom: 10px;
    }
    .dm-compose .label{
      font-size: 12px;
      color: rgba(0,0,0,0.65);
      font-weight: 900;
    }
    .dm-compose input, .dm-compose textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.90);
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
    }
    .dm-compose textarea{
      min-height: 140px;
      resize: vertical;
      line-height: 1.55;
    }
    .dm-compose input[readonly]{
      background: rgba(255,255,255,0.70);
      color: rgba(0,0,0,0.65);
    }

    .dm-hint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(0,0,0,0.60);
      line-height: 1.35;
      min-height: 18px;
    }

    @media (max-width: 560px){
      .dm-tab, .dm-pill, .dm-mini{ height: 44px; font-size: 14px; }
      .dm-msg .body{ font-size: 15px; }
      .dm-list{ max-height: min(62vh, 560px); }
    }
  </style>
</head>

<body>
  <div class="wallpaper"></div>

  <div class="desk" id="desk">

    <!-- 0) ê³µì§€/ê²Œì‹œíŒ ì•ˆë‚´ ì°½ -->
    <div class="win is-front" data-key="notice" style="left:18px; top:18px; width: 260px;" data-z="50">
      <div class="titlebar">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">êµ¬ì¸ ê²Œì‹œíŒ</div>
        </div>
        <div class="title-btns">
          <div class="btn"></div><div class="btn"></div><div class="btn"></div>
        </div>
      </div>
      <div class="content">
        <div class="note">
          <b>Dear Miracle</b>
          ê°€ê°œì¥ ê¸°ê°„ ë™ì•ˆë§Œ ìš´ì˜í•©ë‹ˆë‹¤.
          <ul>
            <li>êµ¬ì¸ê²Œì‹œíŒ: ì „ì²´ ê³µê°œ</li>
            <li>ì»¨íƒ: ë¹„ë°€ëŒ“ê¸€(ê´€ë¦¬ì+ê¸€ì“´ì´)</li>
            <li>ì™„ë£Œ ì‹œ ê´€ê³„ë€ í•œ ì¤„ ê¸°ì¬</li>
          </ul>
          <div style="margin-top:10px;">
            <a href="board.html">ê²Œì‹œíŒ ë“¤ì–´ê°€ê¸°</a>
          </div>
        </div>
      </div>
    </div>

    <!-- 1 -->
    <div class="win" data-key="w1" style="left:270px; top:70px;" data-z="10">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_002.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img01.jpg" alt=""></div>
        <div class="meta"><span>Preview Â· File Â· Edit Â· View</span><span>â€”</span></div>
      </div>
    </div>

    <!-- 2 -->
    <div class="win" data-key="w2" style="left:510px; top:92px; width: 360px;" data-z="11">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_006.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img02.jpg" alt=""></div>
        <div class="meta"><span>00:17</span><span> </span></div>
      </div>
    </div>

    <!-- 3 -->
    <div class="win" data-key="w3" style="left:210px; top:250px; width: 520px;" data-z="12">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_003.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img03.jpg" alt=""></div>
        <div class="meta"><span>â–¶ 02:47</span><span> </span></div>
      </div>
    </div>

    <!-- 4 (âœ… ì˜¤ë¥˜ ìˆ˜ì • ì™„ë£Œ) -->
    <div class="win" data-key="w4" style="left:40px; top:520px; width: 440px;" data-z="13">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_004.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img04.jpg" alt=""></div>
        <div class="meta"><span>Saved 1 min ago</span><span> </span></div>
      </div>
    </div>

    <!-- 5 -->
    <div class="win" data-key="w5" style="left:380px; top:520px; width: 520px;" data-z="14">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_005.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img05.jpg" alt=""></div>
        <div class="meta"><span>Continue listening?</span><span> </span></div>
      </div>
    </div>

    <!-- 6 -->
    <div class="win" data-key="w6" style="left:760px; top:290px; width: 260px;" data-z="15">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_007.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img06.jpg" alt=""></div>
        <div class="meta"><span> </span><span> </span></div>
      </div>
    </div>

    <!-- 7 -->
    <div class="win" data-key="w7" style="left:860px; top:70px; width: 260px;" data-z="16">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_008.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img07.jpg" alt=""></div>
        <div class="meta"><span> </span><span> </span></div>
      </div>
    </div>

    <!-- 8 -->
    <div class="win" data-key="w8" style="left:880px; top:430px; width: 320px;" data-z="17">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_009.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img08.jpg" alt=""></div>
        <div class="meta"><span> </span><span> </span></div>
      </div>
    </div>

    <!-- 9 -->
    <div class="win" data-key="w10" style="left:620px; top:360px; width: 360px;" data-z="18">
      <div class="titlebar">
        <div class="title-left"><div class="dot"></div><div class="title">0722_1029_010.mp4</div></div>
        <div class="title-btns"><div class="btn"></div><div class="btn"></div><div class="btn"></div></div>
      </div>
      <div class="content">
        <div class="media"><img src="img09.jpg" alt=""></div>
        <div class="meta"><span> </span><span> </span></div>
      </div>
    </div>

    <!-- ğŸµ YouTube Playlist Window -->
    <div class="win yt-window" data-key="yt" id="ytWin" style="top:260px; left:40px;" data-z="9">
      <div class="titlebar" id="ytDrag">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">0722_1029_011.mp4</div>
        </div>
        <div class="title-btns">
          <button class="sound-btn" id="ytSoundBtn">ğŸ”‡</button>
          <div class="btn"></div><div class="btn"></div><div class="btn"></div>
        </div>
      </div>

      <div class="content">
        <iframe
          id="ytFrame"
          src="https://www.youtube.com/embed/videoseries?list=PLUE3Cb-ZSnOeLPneQRPY76iI9h9NCQMp6&autoplay=1&loop=1&mute=1"
          allow="autoplay; encrypted-media"
          allowfullscreen>
        </iframe>
      </div>
    </div>

  </div>

  <!-- âœ… ìª½ì§€ ì•„ì´ì½˜(ì¸ë±ìŠ¤ ì „ìš©) -->
  <div class="dm-fab">
    <button id="dmFabBtn" title="ìª½ì§€í•¨">âœ‰ï¸</button>
    <div class="dm-badge" id="dmBadge">0</div>
  </div>

  <!-- âœ… ë©”ì‹ ì €(ì¸ë±ìŠ¤ ì „ìš© ëª¨ë‹¬): ë°›ì€/ë³´ë‚¸ + ì¦‰ì‹œë‹µì¥ -->
  <div class="dm-backdrop" id="dmBg">
    <div class="dm-modal">
      <div class="titlebar">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title" id="dmTitle">ë‚´ ìª½ì§€í•¨</div>
        </div>
        <div class="title-btns">
          <div class="btn" id="dmCloseBtn" title="ë‹«ê¸°"></div>
        </div>
      </div>

      <div class="dm-head">
        <div class="dm-tabs">
          <button class="dm-tab active" id="dmTabRecv">ë°›ì€ ìª½ì§€</button>
          <button class="dm-tab" id="dmTabSent">ë³´ë‚¸ ìª½ì§€</button>
          <button class="dm-pill" id="dmRefresh">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <button class="dm-pill" id="dmNickBtn">ë‹‰ë„¤ì„</button>
      </div>

      <div class="dm-body">
        <div class="dm-list" id="dmList"></div>

        <!-- ë‹µì¥/ìƒˆ ìª½ì§€ ì‘ì„± -->
        <div class="dm-compose" id="dmCompose">
          <div style="flex:1; min-width: 240px;">
            <div class="field">
              <div class="label">ë°›ëŠ” ì‚¬ëŒ</div>
              <input id="dmTo" readonly />
            </div>
            <div class="field">
              <div class="label">ë³´ë‚´ëŠ” ì‚¬ëŒ</div>
              <input id="dmFrom" readonly />
            </div>
            <div class="field">
              <div class="label">ë‚´ìš©</div>
              <textarea id="dmBody" placeholder="ë‹µì¥ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
            </div>
            <div class="dm-actions">
              <button class="dm-mini ghost" id="dmCancel">ì·¨ì†Œ</button>
              <button class="dm-mini" id="dmSend">ë³´ë‚´ê¸°</button>
            </div>
          </div>
        </div>

        <div class="dm-hint" id="dmHint"></div>
      </div>
    </div>
  </div>

  <div class="taskbar">
    <div class="start" onclick="alert('Dear Miracle')">Start</div>
    <div class="brand">Dear Miracle</div>
    <div class="spacer"></div>
    <div class="clock" id="clock">--:--</div>
  </div>

  <!-- âœ… ë‹‰ë„¤ì„ ì…ë ¥(ì¸ë±ìŠ¤ ì „ìš©, board.htmlê³¼ í‚¤ ê³µìœ ) -->
  <div class="dm-backdrop" id="nickBg" style="z-index: 100000; display:none;">
    <div class="dm-modal" style="width: min(520px, 100%);">
      <div class="titlebar" style="cursor: default;">
        <div class="title-left">
          <div class="dot"></div>
          <div class="title">ë‹‰ë„¤ì„ ì…ë ¥</div>
        </div>
        <div class="title-btns">
          <div class="btn" id="nickClose" title="ë‹«ê¸°"></div>
        </div>
      </div>
      <div class="dm-body">
        <div class="dm-compose" style="display:block;">
          <div class="field">
            <div class="label">ë‹‰ë„¤ì„</div>
            <input id="nickInput" placeholder="ì˜ˆ: DearMiracle / ã…‡ã…‡ / ë‹‰ë„¤ì„" maxlength="30" />
          </div>
          <div class="dm-actions" style="justify-content:flex-end;">
            <button class="dm-mini ghost" id="nickCancel">ì·¨ì†Œ</button>
            <button class="dm-mini" id="nickSave">í™•ì¸</button>
          </div>
        </div>
        <div class="dm-hint" id="nickHint"></div>
      </div>
    </div>
  </div>

  <script>
  // ===== ì°½ ë“œë˜ê·¸ + ì•ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° + (ì²« ë¡œë”©) í™”ë©´ë³„ ìë™ ë°°ì¹˜ =====
  const wins = Array.from(document.querySelectorAll(".win"));
  let topZ = 100;
  let hasUserMoved = false;

  function bringToFront(win){
    topZ += 1;
    win.style.zIndex = topZ;
    wins.forEach(w => w.classList.remove("is-front"));
    win.classList.add("is-front");
  }

  function clamp(n, min, max){ return Math.min(Math.max(n, min), max); }

  function place(win, x01, y01){
    const taskbar = document.querySelector(".taskbar");
    const taskH = taskbar ? taskbar.offsetHeight : 44;

    const vw = window.innerWidth;
    const vh = window.innerHeight;

    const marginX = 18;
    const marginTop = 18;
    const marginBottom = taskH + 18;

    const w = win.offsetWidth;
    const h = win.offsetHeight;

    const usableW = vw - marginX*2 - w;
    const usableH = vh - marginTop - marginBottom - h;

    let left = marginX + (usableW * x01);
    let top  = marginTop + (usableH * y01);

    const maxX = vw - 60;
    const maxY = vh - 120;
    left = clamp(left, -40, maxX);
    top  = clamp(top,  -20, maxY);

    win.style.left = left + "px";
    win.style.top  = top  + "px";
  }

  function autoLayout(){
    if(hasUserMoved) return;

    const byKey = {};
    wins.forEach(w => { byKey[w.dataset.key] = w; });

    const vw = window.innerWidth;

    if(vw >= 1100){
      if(byKey.notice) place(byKey.notice, 0.02, 0.03);
      if(byKey.yt)     place(byKey.yt,     0.05, 0.45);

      if(byKey.w1)     place(byKey.w1,     0.22, 0.12);
      if(byKey.w2)     place(byKey.w2,     0.50, 0.15);
      if(byKey.w3)     place(byKey.w3,     0.28, 0.42);

      if(byKey.w4)     place(byKey.w4,     0.05, 0.78);
      if(byKey.w5)     place(byKey.w5,     0.35, 0.80);

      if(byKey.w7)     place(byKey.w7,     0.78, 0.10);
      if(byKey.w6)     place(byKey.w6,     0.70, 0.45);
      if(byKey.w8)     place(byKey.w8,     0.80, 0.62);

      if(byKey.w10)    place(byKey.w10,    0.72, 0.82);
      return;
    }

    if(vw >= 700){
      if(byKey.notice) place(byKey.notice, 0.03, 0.03);
      if(byKey.yt)     place(byKey.yt,     0.03, 0.55);

      if(byKey.w1)     place(byKey.w1,     0.45, 0.10);
      if(byKey.w2)     place(byKey.w2,     0.45, 0.35);
      if(byKey.w3)     place(byKey.w3,     0.20, 0.30);

      if(byKey.w4)     place(byKey.w4,     0.03, 0.78);
      if(byKey.w5)     place(byKey.w5,     0.45, 0.78);

      if(byKey.w6)     place(byKey.w6,     0.70, 0.50);
      if(byKey.w7)     place(byKey.w7,     0.70, 0.05);
      if(byKey.w8)     place(byKey.w8,     0.70, 0.70);

      if(byKey.w10)    place(byKey.w10,    0.45, 0.60);
      return;
    }

    const order = ["notice","yt","w1","w2","w3","w4","w5","w6","w7","w8","w10"];
    let y = 0.03;
    order.forEach((k, i) => {
      const w = byKey[k];
      if(!w) return;
      place(w, (i % 2 ? 0.08 : 0.02), y);
      y += 0.07;
    });
  }

  wins.forEach(win => {
    const initZ = parseInt(win.getAttribute("data-z") || "0", 10);
    win.style.zIndex = 50 + initZ;

    win.addEventListener("pointerdown", () => bringToFront(win));

    const bar = win.querySelector(".titlebar");
    let dragging = false;
    let startX = 0, startY = 0;
    let winX = 0, winY = 0;

    bar.addEventListener("pointerdown", (e) => {
      // ìœ íŠœë¸Œ sound-btn ê°™ì€ ë²„íŠ¼ í´ë¦­ì€ ë“œë˜ê·¸ë¡œ ì•ˆ ì¡íˆê²Œ
      const t = e.target;
      if(t && t.tagName === "BUTTON") return;

      bringToFront(win);
      dragging = true;
      hasUserMoved = true;
      bar.setPointerCapture(e.pointerId);

      const rect = win.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      winX = rect.left;
      winY = rect.top;

      e.preventDefault();
    });

    bar.addEventListener("pointermove", (e) => {
      if(!dragging) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      let nx = winX + dx;
      let ny = winY + dy;

      const maxX = window.innerWidth - 60;
      const maxY = window.innerHeight - 120;
      nx = Math.min(Math.max(nx, -40), maxX);
      ny = Math.min(Math.max(ny, -20), maxY);

      win.style.left = nx + "px";
      win.style.top  = ny + "px";
    });

    bar.addEventListener("pointerup", () => dragging = false);
    bar.addEventListener("pointercancel", () => dragging = false);
  });

  window.addEventListener("load", () => autoLayout());
  window.addEventListener("resize", () => autoLayout());

  // ===== ì‹œê³„ =====
  const clock = document.getElementById("clock");
  function tick(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    clock.textContent = `${hh}:${mm}`;
  }
  tick();
  setInterval(tick, 1000 * 10);

  // ===== ìœ íŠœë¸Œ ì†Œë¦¬ ë²„íŠ¼(iframe src í† ê¸€) =====
  const ytFrame = document.getElementById("ytFrame");
  const soundBtn = document.getElementById("ytSoundBtn");
  let isMuted = true;

  soundBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const url = new URL(ytFrame.src);
    url.searchParams.set("mute", isMuted ? "0" : "1");
    ytFrame.src = url.toString();

    isMuted = !isMuted;
    soundBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
  });
  </script>

  <!-- =========================================================
       âœ… Firebase ìª½ì§€(ì¸ë±ìŠ¤): ì•ˆì½ìŒ ë±ƒì§€ + ë©”ì‹ ì € ëª¨ë‹¬ + ì¦‰ì‹œ ë‹µì¥
       - board.htmlì´ë‘ ê°™ì€ messages ì»¬ë ‰ì…˜ ì‚¬ìš©
       - ë‹‰ë„¤ì„ í‚¤ë„ boardë‘ ê³µìœ : localStorage "dm_nick"
       ========================================================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âœ… board.htmlì˜ firebaseConfigì™€ "ì™„ì „íˆ ë™ì¼" í•´ì•¼ í•¨
    const firebaseConfig = {
      apiKey: "AIzaSyA1PxEOrwjVi4BOLA13UbFIncTYe6RdYIQ",
      authDomain: "dear-miracle.firebaseapp.com",
      projectId: "dear-miracle",
      storageBucket: "dear-miracle.firebasestorage.app",
      messagingSenderId: "793139917614",
      appId: "1:793139917614:web:dec74f65af6a0df1c740bf",
      measurementId: "G-VF22L8ZR6D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    // ===== ë‹‰ë„¤ì„(ì„¸ì…˜) =====
    const NICK_KEY = "dm_nick";
    const READ_KEY_PREFIX = "dm_read_cutoff_"; // dm_read_cutoff_<nick>

    function getNick(){ return (localStorage.getItem(NICK_KEY) || "").trim(); }
    function setNick(n){ localStorage.setItem(NICK_KEY, (n||"").trim()); }
    function getReadCutoff(nick){
      const raw = localStorage.getItem(READ_KEY_PREFIX + nick);
      const ms = raw ? parseInt(raw, 10) : 0;
      return Number.isFinite(ms) ? ms : 0;
    }
    function setReadCutoff(nick, ms){
      localStorage.setItem(READ_KEY_PREFIX + nick, String(ms));
    }

    function fmtTime(ts){
      if(!ts) return "";
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const yy = String(d.getFullYear()).slice(2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${yy}.${mm}.${dd} ${hh}:${mi}`;
      }catch{
        return "";
      }
    }

    // ===== UI refs =====
    const dmFabBtn = $("dmFabBtn");
    const dmBadge  = $("dmBadge");

    const dmBg     = $("dmBg");
    const dmCloseBtn = $("dmCloseBtn");

    const dmTabRecv = $("dmTabRecv");
    const dmTabSent = $("dmTabSent");
    const dmRefresh = $("dmRefresh");
    const dmNickBtn = $("dmNickBtn");

    const dmList   = $("dmList");
    const dmHint   = $("dmHint");

    const dmCompose = $("dmCompose");
    const dmTo    = $("dmTo");
    const dmFrom  = $("dmFrom");
    const dmBody  = $("dmBody");
    const dmCancel = $("dmCancel");
    const dmSend   = $("dmSend");

    // ë‹‰ ëª¨ë‹¬
    const nickBg = $("nickBg");
    const nickClose = $("nickClose");
    const nickInput = $("nickInput");
    const nickCancel = $("nickCancel");
    const nickSave = $("nickSave");
    const nickHint = $("nickHint");

    // ===== ëª¨ë“œ =====
    let inboxMode = "recv"; // recv | sent

    function setTab(mode){
      inboxMode = mode;
      dmTabRecv.classList.toggle("active", mode==="recv");
      dmTabSent.classList.toggle("active", mode==="sent");
    }

    function openNickModal(force=false){
      nickHint.textContent = "";
      nickInput.value = getNick();
      nickBg.style.display = "flex";
      // forceì¼ ë•Œ ë‹«ê¸° ìˆ¨ê¸°ë ¤ë©´:
      nickClose.style.display = force ? "none" : "block";
      setTimeout(()=> nickInput.focus(), 30);
    }
    function closeNickModal(){
      nickBg.style.display = "none";
    }

    function ensureNick(){
      const n = getNick();
      if(!n){
        openNickModal(true);
        return false;
      }
      return true;
    }

    nickSave.addEventListener("click", ()=>{
      const val = (nickInput.value || "").trim();
      if(!val){
        nickHint.textContent = "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        return;
      }
      setNick(val);
      closeNickModal();
      refreshBadge(); // ë‹‰ ì„¤ì • í›„ ë±ƒì§€ ê°±ì‹ 
    });
    nickCancel.addEventListener("click", ()=>{
      if(getNick()) closeNickModal();
      else nickHint.textContent = "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì•¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    });
    nickClose.addEventListener("click", closeNickModal);
    nickBg.addEventListener("click", (e)=>{ if(e.target===nickBg && getNick()) closeNickModal(); });

    // ===== DM ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° =====
    function openDM(){
      if(!ensureNick()) return;
      dmBg.style.display = "flex";
      setTab("recv");
      dmCompose.style.display = "none";
      dmFrom.value = getNick();
      loadInbox();     // ëª©ë¡
      markReadNow();   // ì—´ì—ˆìœ¼ë©´ "ì§€ê¸ˆê¹Œì§€ëŠ” ì½ìŒ" ì²˜ë¦¬
    }
    function closeDM(){
      dmBg.style.display = "none";
      dmCompose.style.display = "none";
      dmHint.textContent = "";
    }

    dmFabBtn.addEventListener("click", openDM);
    dmCloseBtn.addEventListener("click", closeDM);
    dmBg.addEventListener("click", (e)=>{ if(e.target===dmBg) closeDM(); });

    dmNickBtn.addEventListener("click", ()=> openNickModal(false));

    dmTabRecv.addEventListener("click", ()=>{ if(!ensureNick()) return; setTab("recv"); dmCompose.style.display="none"; loadInbox(); });
    dmTabSent.addEventListener("click", ()=>{ if(!ensureNick()) return; setTab("sent"); dmCompose.style.display="none"; loadInbox(); });
    dmRefresh.addEventListener("click", ()=>{ if(!ensureNick()) return; dmCompose.style.display="none"; loadInbox(); refreshBadge(); });

    // ===== ì•ˆì½ìŒ ê³„ì‚°(ë¡œì»¬ ê¸°ì¤€) =====
    // - "ì§„ì§œ ì½ìŒ" í•„ë“œëŠ” DBì— ì—†ìŒ(ì§€ê¸ˆ êµ¬ì¡° ê·¸ëŒ€ë¡œ)
    // - ê·¸ë˜ì„œ: "ìª½ì§€í•¨ì„ ì—° ì‹œê°„"ì„ ë‚´ ë¡œì»¬ì— ì €ì¥í•´ì„œ
    //   ê·¸ ì´í›„ë¡œ ì˜¨ 'ë°›ì€ ìª½ì§€'ë§Œ ì•ˆì½ìŒìœ¼ë¡œ í‘œì‹œ
    function markReadNow(){
      const me = getNick();
      if(!me) return;
      setReadCutoff(me, Date.now());
      updateBadge(0);
    }

    function updateBadge(n){
      const num = Math.max(0, Number(n)||0);
      dmBadge.textContent = String(num);
      dmBadge.style.display = num > 0 ? "inline-flex" : "none";
    }

    async function refreshBadge(){
      const me = getNick();
      if(!me){
        updateBadge(0);
        return;
      }

      // "ë°›ì€ ìª½ì§€" ì¤‘, cutoff ì´í›„ createdAtì¸ ê²ƒë§Œ ì¹´ìš´íŠ¸
      const cutoffMs = getReadCutoff(me);
      try{
        const qy = query(
          collection(db, "messages"),
          where("to", "==", me),
          orderBy("createdAt", "desc"),
          limit(50)
        );

        const snap = await getDocs(qy);
        let cnt = 0;
        snap.forEach(docu=>{
          const m = docu.data();
          const t = m.createdAt?.toDate ? m.createdAt.toDate().getTime() : 0;
          if(t && t > cutoffMs) cnt += 1;
        });

        updateBadge(cnt);
      }catch(err){
        console.error(err);
        // ì‹¤íŒ¨í•´ë„ ë±ƒì§€ëŠ” ê·¸ëƒ¥ ìœ ì§€/ìˆ¨ê¹€
      }
    }

    // ===== ëª©ë¡ ë¡œë“œ + ë Œë” + â€œë°”ë¡œ ë‹µì¥â€ =====
    function showHint(s){ dmHint.textContent = s || ""; }

    function openCompose(toNick){
      if(!ensureNick()) return;
      dmCompose.style.display = "flex";
      dmFrom.value = getNick();
      dmTo.value = (toNick || "").trim();
      dmBody.value = "";
      setTimeout(()=> dmBody.focus(), 20);
    }
    function closeCompose(){
      dmCompose.style.display = "none";
      dmTo.value = "";
      dmBody.value = "";
    }

    dmCancel.addEventListener("click", closeCompose);

    dmSend.addEventListener("click", async ()=>{
      if(!ensureNick()) return;

      const from = getNick();
      const to = (dmTo.value || "").trim();
      const body = (dmBody.value || "").trim();

      if(!to){
        showHint("ë°›ëŠ” ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if(to === from){
        showHint("ìê¸° ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if(!body){
        showHint("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      try{
        dmSend.disabled = true;
        showHint("ì „ì†¡ ì¤‘â€¦");

        await addDoc(collection(db, "messages"), {
          from, to, body,
          postId: "", // ì¸ë±ìŠ¤ì—ì„œ ë³´ë‚¸ ê±´ ì—°ê²°ê¸€ ì—†ìŒ
          createdAt: serverTimestamp()
        });

        showHint("ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeCompose();
        // ë³´ë‚¸í•¨ ê°±ì‹ ê¹Œì§€ ì›í•˜ë©´ ìœ ì§€:
        if(inboxMode === "sent") await loadInbox();
        await refreshBadge();
      }catch(err){
        console.error(err);
        showHint("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }finally{
        dmSend.disabled = false;
      }
    });

    async function loadInbox(){
      const me = getNick();
      if(!me) return;

      dmList.innerHTML = "";
      showHint("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");

      try{
        let qy;
        if(inboxMode === "recv"){
          qy = query(
            collection(db, "messages"),
            where("to", "==", me),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        }else{
          qy = query(
            collection(db, "messages"),
            where("from", "==", me),
            orderBy("createdAt", "desc"),
            limit(50)
          );
        }

        const snap = await getDocs(qy);

        if(snap.empty){
          showHint(inboxMode==="recv" ? "ë°›ì€ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤." : "ë³´ë‚¸ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const cutoffMs = getReadCutoff(me);
        const frag = document.createDocumentFragment();

        snap.forEach(docu=>{
          const m = docu.data();
          const div = document.createElement("div");
          div.className = "dm-msg";

          const top = document.createElement("div");
          top.className = "top";

          const t = fmtTime(m.createdAt);
          const whenMs = m.createdAt?.toDate ? m.createdAt.toDate().getTime() : 0;

          // ì•ˆì½ìŒ í‘œì‹œ(ë°›ì€í•¨ì—ì„œë§Œ)
          const isUnread = inboxMode==="recv" && whenMs && whenMs > cutoffMs;

          const who = inboxMode==="recv"
            ? `ë³´ë‚¸ ì‚¬ëŒ: ${m.from || "-"}`
            : `ë°›ëŠ” ì‚¬ëŒ: ${m.to || "-"}`;

          top.textContent = `${who} Â· ${t}${isUnread ? " Â· ì•ˆì½ìŒ" : ""}`;

          const body = document.createElement("div");
          body.className = "body";
          body.textContent = m.body || "";

          div.appendChild(top);
          div.appendChild(body);

          // âœ… ë°›ì€í•¨ì—ì„œëŠ” "ë°”ë¡œ ë‹µì¥" ë²„íŠ¼ ì œê³µ
          if(inboxMode === "recv"){
            const actions = document.createElement("div");
            actions.className = "dm-actions";

            const reply = document.createElement("button");
            reply.className = "dm-mini";
            reply.textContent = "ë°”ë¡œ ë‹µì¥";
            reply.addEventListener("click", (e)=>{
              e.stopPropagation();
              openCompose(m.from || "");
            });

            actions.appendChild(reply);
            div.appendChild(actions);
          }

          frag.appendChild(div);
        });

        dmList.appendChild(frag);
        showHint("");

        // ëª©ë¡ì„ ì—´ì–´ë´¤ìœ¼ë‹ˆ ì½ìŒ ì²˜ë¦¬ + ë±ƒì§€ ê°±ì‹ 
        markReadNow();
        await refreshBadge();
      }catch(err){
        console.error(err);
        showHint("ìª½ì§€í•¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // ===== ì´ˆê¸°: ë±ƒì§€ ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹  =====
    // (firebase onSnapshot ì•ˆ ì“°ê³ , ê°€ë²¼ìš´ í´ë§ë¡œì§)
    await refreshBadge();
    setInterval(refreshBadge, 15000); // 15ì´ˆë§ˆë‹¤

  </script>
</body>
</html>
